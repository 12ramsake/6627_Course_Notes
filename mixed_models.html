<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Notes for MATH 6627: Statistical Consulting Practicum - 1&nbsp; Mixed Models</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./references.html" rel="next">
<link href="./index.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="site_libs/quarto-diagram/mermaid.min.js"></script>
<script src="site_libs/quarto-diagram/mermaid-init.js"></script>
<link href="site_libs/quarto-diagram/mermaid.css" rel="stylesheet">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./mixed_models.html"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Mixed Models</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Notes for MATH 6627: Statistical Consulting Practicum</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./mixed_models.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Mixed Models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#clustered-data" id="toc-clustered-data" class="nav-link active" data-scroll-target="#clustered-data"><span class="header-section-number">1.1</span> Clustered data</a>
  <ul class="collapse">
  <li><a href="#sec-mlr" id="toc-sec-mlr" class="nav-link" data-scroll-target="#sec-mlr"><span class="header-section-number">1.1.1</span> Review of multiple linear regression</a></li>
  <li><a href="#sec-oz" id="toc-sec-oz" class="nav-link" data-scroll-target="#sec-oz"><span class="header-section-number">1.1.2</span> An example</a></li>
  <li><a href="#additional-challenges-with-clustered-data" id="toc-additional-challenges-with-clustered-data" class="nav-link" data-scroll-target="#additional-challenges-with-clustered-data"><span class="header-section-number">1.1.3</span> Additional challenges with clustered data</a></li>
  <li><a href="#homework-questions" id="toc-homework-questions" class="nav-link" data-scroll-target="#homework-questions"><span class="header-section-number">1.1.4</span> Homework questions</a></li>
  </ul></li>
  <li><a href="#analysing-clustered-data-with-mixed-models" id="toc-analysing-clustered-data-with-mixed-models" class="nav-link" data-scroll-target="#analysing-clustered-data-with-mixed-models"><span class="header-section-number">1.2</span> Analysing clustered data with mixed models</a>
  <ul class="collapse">
  <li><a href="#random-effects" id="toc-random-effects" class="nav-link" data-scroll-target="#random-effects"><span class="header-section-number">1.2.1</span> Random effects</a></li>
  <li><a href="#homework-questions-1" id="toc-homework-questions-1" class="nav-link" data-scroll-target="#homework-questions-1"><span class="header-section-number">1.2.2</span> Homework questions</a></li>
  <li><a href="#regression-and-general-data-modelling-review" id="toc-regression-and-general-data-modelling-review" class="nav-link" data-scroll-target="#regression-and-general-data-modelling-review"><span class="header-section-number">1.2.3</span> Regression and general data modelling review</a></li>
  <li><a href="#defining-the-linear-mixed-model" id="toc-defining-the-linear-mixed-model" class="nav-link" data-scroll-target="#defining-the-linear-mixed-model"><span class="header-section-number">1.2.4</span> Defining the linear mixed model</a></li>
  <li><a href="#special-cases-of-single-layer-models" id="toc-special-cases-of-single-layer-models" class="nav-link" data-scroll-target="#special-cases-of-single-layer-models"><span class="header-section-number">1.2.5</span> Special cases of single layer models</a></li>
  <li><a href="#multi-level-models" id="toc-multi-level-models" class="nav-link" data-scroll-target="#multi-level-models"><span class="header-section-number">1.2.6</span> Multi-level models</a></li>
  <li><a href="#parameter-estimation-and-inference" id="toc-parameter-estimation-and-inference" class="nav-link" data-scroll-target="#parameter-estimation-and-inference"><span class="header-section-number">1.2.7</span> Parameter estimation and inference</a></li>
  <li><a href="#individual-effects" id="toc-individual-effects" class="nav-link" data-scroll-target="#individual-effects"><span class="header-section-number">1.2.8</span> Individual effects</a></li>
  <li><a href="#exploratory-analysis-checking-assumptions-and-sensitivity-testing" id="toc-exploratory-analysis-checking-assumptions-and-sensitivity-testing" class="nav-link" data-scroll-target="#exploratory-analysis-checking-assumptions-and-sensitivity-testing"><span class="header-section-number">1.2.9</span> Exploratory analysis, checking assumptions and sensitivity testing</a></li>
  <li><a href="#homework-questions-2" id="toc-homework-questions-2" class="nav-link" data-scroll-target="#homework-questions-2"><span class="header-section-number">1.2.10</span> Homework questions</a></li>
  </ul></li>
  <li><a href="#case-study-batches-of-antibiotic-and-quality-control" id="toc-case-study-batches-of-antibiotic-and-quality-control" class="nav-link" data-scroll-target="#case-study-batches-of-antibiotic-and-quality-control"><span class="header-section-number">1.3</span> Case study: Batches of antibiotic and quality control</a>
  <ul class="collapse">
  <li><a href="#case-information" id="toc-case-information" class="nav-link" data-scroll-target="#case-information"><span class="header-section-number">1.3.1</span> Case information:</a></li>
  </ul></li>
  <li><a href="#case-study-air-pollution" id="toc-case-study-air-pollution" class="nav-link" data-scroll-target="#case-study-air-pollution"><span class="header-section-number">1.4</span> Case study: Air Pollution</a>
  <ul class="collapse">
  <li><a href="#case-information-1" id="toc-case-information-1" class="nav-link" data-scroll-target="#case-information-1"><span class="header-section-number">1.4.1</span> Case information:</a></li>
  <li><a href="#eda" id="toc-eda" class="nav-link" data-scroll-target="#eda"><span class="header-section-number">1.4.2</span> EDA:</a></li>
  <li><a href="#specifying" id="toc-specifying" class="nav-link" data-scroll-target="#specifying"><span class="header-section-number">1.4.3</span> Specifying</a></li>
  <li><a href="#estimation" id="toc-estimation" class="nav-link" data-scroll-target="#estimation"><span class="header-section-number">1.4.4</span> Estimation</a></li>
  <li><a href="#testing" id="toc-testing" class="nav-link" data-scroll-target="#testing"><span class="header-section-number">1.4.5</span> Testing</a></li>
  <li><a href="#diagnostics" id="toc-diagnostics" class="nav-link" data-scroll-target="#diagnostics"><span class="header-section-number">1.4.6</span> Diagnostics</a></li>
  <li><a href="#results-summary" id="toc-results-summary" class="nav-link" data-scroll-target="#results-summary"><span class="header-section-number">1.4.7</span> Results summary:</a></li>
  </ul></li>
  <li><a href="#case-study-tale-of-two-thieves-see-cabrera2002" id="toc-case-study-tale-of-two-thieves-see-cabrera2002" class="nav-link" data-scroll-target="#case-study-tale-of-two-thieves-see-cabrera2002"><span class="header-section-number">1.5</span> Case study: Tale of two thieves, see <span class="citation" data-cites="Cabrera2002">Cabrera and McDougall (2002)</span></a>
  <ul class="collapse">
  <li><a href="#case-information-2" id="toc-case-information-2" class="nav-link" data-scroll-target="#case-information-2"><span class="header-section-number">1.5.1</span> Case information:</a></li>
  <li><a href="#outline-of-the-problem" id="toc-outline-of-the-problem" class="nav-link" data-scroll-target="#outline-of-the-problem"><span class="header-section-number">1.5.2</span> Outline of the Problem</a></li>
  <li><a href="#experiment-procedure" id="toc-experiment-procedure" class="nav-link" data-scroll-target="#experiment-procedure"><span class="header-section-number">1.5.3</span> Experiment Procedure</a></li>
  <li><a href="#eda-1" id="toc-eda-1" class="nav-link" data-scroll-target="#eda-1"><span class="header-section-number">1.5.4</span> EDA</a></li>
  <li><a href="#specification" id="toc-specification" class="nav-link" data-scroll-target="#specification"><span class="header-section-number">1.5.5</span> Specification</a></li>
  <li><a href="#diagnostics-1" id="toc-diagnostics-1" class="nav-link" data-scroll-target="#diagnostics-1"><span class="header-section-number">1.5.6</span> Diagnostics</a></li>
  </ul></li>
  <li><a href="#case-study-treatment-of-lead-exposed-children" id="toc-case-study-treatment-of-lead-exposed-children" class="nav-link" data-scroll-target="#case-study-treatment-of-lead-exposed-children"><span class="header-section-number">1.6</span> Case study: Treatment of Lead-Exposed Children</a>
  <ul class="collapse">
  <li><a href="#modelling" id="toc-modelling" class="nav-link" data-scroll-target="#modelling"><span class="header-section-number">1.6.1</span> Modelling:</a></li>
  <li><a href="#longitudinal-data-as-a-mixed-effects-model" id="toc-longitudinal-data-as-a-mixed-effects-model" class="nav-link" data-scroll-target="#longitudinal-data-as-a-mixed-effects-model"><span class="header-section-number">1.6.2</span> Longitudinal Data as a mixed effects model</a></li>
  <li><a href="#sensitivity-analysis---we-could-have-fit-a-quadratic-or-piece-wise-linear-model-to-the-data." id="toc-sensitivity-analysis---we-could-have-fit-a-quadratic-or-piece-wise-linear-model-to-the-data." class="nav-link" data-scroll-target="#sensitivity-analysis---we-could-have-fit-a-quadratic-or-piece-wise-linear-model-to-the-data."><span class="header-section-number">1.6.3</span> Sensitivity analysis - We could have fit a quadratic or piece-wise linear model to the data.</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="sec-mm" class="quarto-section-identifier"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Mixed Models</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="clustered-data" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="clustered-data"><span class="header-section-number">1.1</span> Clustered data</h2>
<section id="sec-mlr" class="level3" data-number="1.1.1">
<h3 data-number="1.1.1" class="anchored" data-anchor-id="sec-mlr"><span class="header-section-number">1.1.1</span> Review of multiple linear regression</h3>
<p>Recall the multiple linear regression model:</p>
<p>For the model <span class="math inline">\(Y|X=X\beta+\epsilon\)</span>, we have</p>
<ul>
<li><p><span class="math inline">\(Y\in \mathbb{R}^{n\times 1}\)</span> is the response variable (a continuous random vector)</p></li>
<li><p><span class="math inline">\(X\in \mathbb{R}^{n\times p}\)</span> is the covariate matrix (Note that the first column is often <span class="math inline">\(1_n\)</span> – the column vector of ones)</p></li>
<li><p><span class="math inline">\(X_i\in \mathbb{R}^{p\times 1}\)</span> is the <span class="math inline">\(i^{th}\)</span> observed explanatory variable <span class="math inline">\((i=1, \ldots, n)\)</span> (not a random variable, in the sense that we condition on it)</p></li>
<li><p><span class="math inline">\(\beta\in \mathbb{R}^{p\times 1}\)</span> is the coefficient vector</p></li>
<li><p><span class="math inline">\(\epsilon\in\mathbb{R}^n\)</span> is the random error (continuous random variable)</p></li>
</ul>
<p>The key assumptions of the (normal) MLR are that</p>
<ul>
<li><p><span class="math inline">\(\epsilon\)</span> is multivariate normally distributed</p></li>
<li><p><span class="math inline">\(E(\epsilon)=0\)</span></p></li>
<li><p><span class="math inline">\(Cov(\epsilon)=\sigma^2 I_n\)</span></p></li>
<li><p><span class="math inline">\(Y|X=X\beta+\epsilon\)</span></p></li>
</ul>
<p>As such, it is critical that when applying MLR models, the observations are <em>independent</em>. However, there are many, many problems where the data contains dependent observations. If we have data that can be split into mutually independent clusters, then we call this <em>clustered data</em>.</p>
</section>
<section id="sec-oz" class="level3" data-number="1.1.2">
<h3 data-number="1.1.2" class="anchored" data-anchor-id="sec-oz"><span class="header-section-number">1.1.2</span> An example</h3>
<p>Consider the following simple example. Suppose a study wishes to prove/disprove the following: <strong>Does Ozempic cause sustained weight loss over time?</strong></p>
<p>What type of data would we need to answer this question? We might start with the question: Can we collect data that would allow us to answer this question with a MLR model?</p>
<p>Could we:</p>
<ul>
<li><p>Take a sample of individuals on Ozempic and measure their weight? – <strong>No</strong><em>.</em> How do we determine if their weight has decreased since starting it?</p></li>
<li><p>Take a sample of individuals both on and not on Ozempic at a point in time, and compare their weights? – <strong>No</strong>. How can we rule out the fact that these are different populations?</p></li>
</ul>
<p>It seems that this question could not be reliably answered using the above suggested methods. We would <strong>need</strong> to be able to follow individuals, starting when they begin Ozempic, recording their weights, and continue following them for a period of time. We might have data that looks like:</p>
<table class="table">
<thead>
<tr class="header">
<th>Month 1</th>
<th>Month 2</th>
<th>Month 3</th>
<th>Month 4</th>
<th>…</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>360</td>
<td>355</td>
<td>350</td>
<td>340</td>
<td>…</td>
</tr>
<tr class="even">
<td>225</td>
<td>222</td>
<td>224</td>
<td>225</td>
<td>…</td>
</tr>
<tr class="odd">
<td>288</td>
<td>270</td>
<td>253</td>
<td>260</td>
<td>…</td>
</tr>
</tbody>
</table>
<p>We could simply compare the weights in month 1 to the last month measured, and apply a one-sample t-test. What if the patients lose weight in the first 6 months and then gain it back? This would not be captured by such a model. We could run one t-test for each month, but of course then the type-1 error would be very large.</p>
<p>It is better to model the weights of patients on Ozempic over time. Inspired by the Normal MLR model, we might posit that patient <span class="math inline">\(i\)</span>s weight at time <span class="math inline">\(j\)</span> is governed by the following equation:</p>
<p><span class="math display">\[Y_{ij}=\beta_0+\beta_{1}t_j+\epsilon_{ij}.\]</span> with <span class="math inline">\(\epsilon_{ij}\sim\mathcal{N}(0,\sigma^2)\)</span>. Now, if we want to apply the Normal MLR model, we would need to assume <span class="math inline">\(\epsilon_{ij}\perp\epsilon_{\ell k}\)</span> when <span class="math inline">\(ij\neq\ell k\)</span> . Is this reasonable? This would implies that <span class="math inline">\(Y_{ij}\perp Y_{ij+1}\)</span>, i.e., a patients weight in month <span class="math inline">\(j\)</span> is independent of their weight in month <span class="math inline">\(j+1\)</span>. This is, of course unreasonable. However, it would be reasonable to assume that <span class="math inline">\(Y_{ij}\perp Y_{\ell k}\)</span> when <span class="math inline">\(\ell\neq i\)</span>. This is an example of <strong>clustered data</strong>. Here the clusters are the patients.</p>
<ul>
<li><p>It is safe to assume that a patient’s weight at a given time is unrelated to another patient’s weight at any given time</p></li>
<li><p>However, a patients weight a given time is related to their past and future weights; the within patient weights are dependent.</p></li>
</ul>
<p>Therefore, a better assumption might be that the <span class="math display">\[Y_{ij}=\beta_{0i}+\beta_{1}t_j+\epsilon_{ij}.\]</span></p>
<p>where <span class="math inline">\(\beta_{0i}\)</span> are now <strong>random variables,</strong> where there exists one per patient. The coefficients <span class="math inline">\(\beta_{0i}\)</span> contain the dependence of the weight within individuals, and allow us to model the random errors as independent: <span class="math inline">\(Cov(\epsilon)=\sigma^2 I\)</span>. This is only one way to model the within-patient dependence between patients.</p>
<div id="exm-EX1" class="theorem example">
<p><span class="theorem-title"><strong>Example 1.1 </strong></span>Testing this theory…</p>
<p>Simplify the correlation between <span class="math inline">\(Y_{ik}\)</span> and <span class="math inline">\(Y_{ij}\)</span> in this model, and in the Normal MLR (the Normal MLR is the MLR, with the added assumption that the errors are normally distributed. Compare the results.</p>
</div>
<div class="solution callout callout-style-simple callout-none no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p>Solution:</p>
<p>Done in lecture.</p>
</div>
</div>
</div>
<p>The previous example is a longitudinal study, which is a sub-type of the more general clustered data. A longitudinal study is a research study in which subjects are followed over time. Typically this involves repeated measurements of the same variables. Longitudinal studies differ from cross-sectional studies and time series studies. Cross-sectional studies have no clusters, and time series follow one ore more variates over time. The random errors in a time series may be correlated.</p>
<p>Longitudinal studies are useful for:</p>
<ul>
<li><p>detecting changes in outcomes, both at the population and individual level,</p></li>
<li><p>assessing <strong>Longitudinal effects,</strong> as compared to cohort effects/cross sectional effects,</p></li>
<li><p>understanding different sources of variation, e.g., between- and within-subject variation.</p></li>
<li><p>detecting <strong>time effects</strong>, both directly and as interactions with other relevant factors.</p></li>
</ul>
<p>One example of longitudinal data, which we will see later is the TLC trial data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="do">########################################################</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>TLC <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/TLC.csv"</span>,<span class="at">stringsAsFactors =</span> T)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(TLC)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  ID Treatment   W0   W1   W4   W6
1  1         P 30.8 26.9 25.8 23.8
2  2         A 26.5 14.8 19.5 21.0
3  3         A 25.8 23.0 19.1 23.2
4  4         P 24.7 24.5 22.0 22.5
5  5         A 20.4  2.8  3.2  9.4
6  6         A 20.4  5.4  4.5 11.9</code></pre>
</div>
</div>
<p>As mentioned, longitudinal data is one example of clustered data. Clustered data refers to data that can be divided into clusters, such that data within a given cluster are correlated. For longitudinal observations, observations taken from the same subject at different time points are correlated because they belong to the same subject. In general, real world data have a complex dependence structure - can often be fit into this clustered framework.</p>
<p>Another example of clustered data is hierarchical data. These data have clusters within clusters. You could make a super dated inception joke here. For instance, if we wanted to assess how a new way of teaching p-values affects statistical literacy, we could sample universities, then professors, then classes. Here, assuming professors teach multiple sections, we could safely assume that the effect of this new teaching method may differ by university, by professor, and by class. In other words, observations within these groups would be correlated.</p>
</section>
<section id="additional-challenges-with-clustered-data" class="level3" data-number="1.1.3">
<h3 data-number="1.1.3" class="anchored" data-anchor-id="additional-challenges-with-clustered-data"><span class="header-section-number">1.1.3</span> Additional challenges with clustered data</h3>
<p>Often, clustered data are accompanied by other, additional challenges.</p>
<ul>
<li>Missing data or dropouts</li>
<li>Measurement errors</li>
<li>Censoring</li>
<li>Outliers</li>
</ul>
<p>The below examples are adapted from <span class="citation" data-cites="Wu2019">Wu (<a href="references.html#ref-Wu2019" role="doc-biblioref">2019</a>)</span> .</p>
<div id="exm-EX6" class="theorem example">
<p><span class="theorem-title"><strong>Example 1.2 </strong></span>Blood pressure</p>
<p>A researcher wishes to evaluate a treatment for reducing high blood pressure. Blood pressures of each subject in the study are measured before and after the treatment. The researcher is also interested in how blood pressures of the subjects change over time after the treatment, so blood pressure is also measured after treatment once a month for 5 months. What are some potential challenges associated with this data? One answer: The data may contain missing values, e.g., drop out. Blood pressure has measurement error – often repeatedly measured.</p>
</div>
<div id="exm-EX7" class="theorem example">
<p><span class="theorem-title"><strong>Example 1.3 </strong></span>Mental distress</p>
<p>Investigate changes in subjects’ mental distress over time in a treatment group and a control group. Mental distress in 239 subjects were measured at baseline, 4, 12, 24, and 60 months, based on their answers to questionnaires. Subjects randomly assigned into two groups: a treatment and a control group. The Global Severity Index (GSI) is used to measure subjects’ distress levels. Other variables such as education, annual income, depression, anxiety, etc. were collected</p>
<p><img src="Plots/mental_d_1.PNG" class="img-fluid" style="width:80.0%" alt="MD1"> <img src="Plots/mental_d_2.PNG" class="img-fluid" style="width:80.0%" alt="MD2"> <img src="Plots/mental_d_3.PNG" class="img-fluid" style="width:80.0%" alt="MD3"></p>
<p>What are some potential issues for analysis?</p>
<p>Substantial individual variability, Missing data, Outliers, Measurement error? GSI influenced by short-term emotional state</p>
</div>
<div id="exm-EX8" class="theorem example">
<p><span class="theorem-title"><strong>Example 1.4 </strong></span>AIDS Study</p>
<p>The following is an AIDS study designed to evaluate an anti-HIV treatment. 53 HIV infected patients were treated with an antiviral regimen. Viral load (RNA) was repeatedly quantified on days 0, 2, 7, 10, 14, 21, and 28, and weeks 8, 12, 24, and 48 after initiation of the treatment. Immunologic markers known as CD4 and CD8 cell counts were also measured along with viral load, as well as some other variables. Viral load has a lower detection limit of 100, i.e., viral loads below 100 are not quantifiable.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Plots/aids_1.PNG" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption class="figure-caption">AD1</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Plots/aids_2.PNG" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption class="figure-caption">AD2</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Plots/aids_3.PNG" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption class="figure-caption">AD3</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Plots/aids_4.PNG" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption class="figure-caption">AD4</figcaption>
</figure>
</div>
<p>Other information about this data is given by:</p>
<ul>
<li>“HIV viral dynamic models model viral load trajectories during an anti-HIV treatment”</li>
<li>“In an HIV viral dynamic model, the relationship between viral load and viral dynamic parameters is often nonlinear, and the viral dynamic parameters often vary substantially across patients.”</li>
<li>Thus, nonlinear mixed effect models</li>
<li>AIDS researchers are also interested in the relationship between viral loads and CD4 counts over time</li>
<li>“CD4 counts are known to be measured with substantial errors, and patients often drop out because of drug side effects or other problems.”</li>
</ul>
<p>What are some potential issues with this dataset?</p>
<ul>
<li>different measurement times across patients</li>
<li>different numbers of within-individual measurements across patients<br>
</li>
<li>large variation between patients</li>
<li>large variation in the data within each patient</li>
<li>some patients dropping out of the study</li>
<li>some viral loads being censored (i.e., below the limit of detection)</li>
<li>substantial measurement errors in the data</li>
<li>complex long-term trajectories</li>
<li>data being missing at measurement times</li>
</ul>
</div>
<p><strong>Multilevel models:</strong> Multilevel models/Hierarchical linear models/Nested data models: Statistical models for “nested clusters”. They contain parameters that vary at more than one level. An example could be a model of student performance, where the data are collected from students from multiple classes from multiple schools.</p>
<p><strong>Other model classes:</strong> Marginal models/GEE models – Mean and the correlation (covariance) structure are modeled separately. Does not require distributional assumptions (see Chapter 10 <span class="citation" data-cites="Wu2019">Wu (<a href="references.html#ref-Wu2019" role="doc-biblioref">2019</a>)</span>) Transitional models – Within-individual correlation is modeled via Markov structures.</p>
</section>
<section id="homework-questions" class="level3" data-number="1.1.4">
<h3 data-number="1.1.4" class="anchored" data-anchor-id="homework-questions"><span class="header-section-number">1.1.4</span> Homework questions</h3>
<ul>
<li>Write down why clustered data are challenging to analyse?</li>
</ul>
</section>
</section>
<section id="analysing-clustered-data-with-mixed-models" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="analysing-clustered-data-with-mixed-models"><span class="header-section-number">1.2</span> Analysing clustered data with mixed models</h2>
<p>A <strong>mixed model</strong> is a convenient modelling framework which can be used to model complex dependency structure within a data set. They are an extension of the familiar Normal MLR model, where the independent errors assumption is relaxed. In order to relax that assumption, a new concept is introduced: the <strong>random effect</strong>.</p>
<section id="random-effects" class="level3" data-number="1.2.1">
<h3 data-number="1.2.1" class="anchored" data-anchor-id="random-effects"><span class="header-section-number">1.2.1</span> Random effects</h3>
<p>In a mixed effect model, the effects of each of the covariates can be split into two categories: fixed and random effects. Deciding on what is a fixed effect and what is a random effect can be difficult, and there is no agreed upon definition: see <a href="https://statmodeling.stat.columbia.edu/2005/01/25/why_i_dont_use/">this post by Andrew Gelman</a>. I will provide some guidance below, but ultimately, there is no binary rule for determining whether one should model an effect as fixed or random. Your model should reflect the assumptions that are reasonable to make about the data at hand, and answer the research questions adequately.</p>
<p>When we model a fixed effect, we only model the average across the whole population. On the other hand, when we model a covariate as a random effect, we are modelling the average effect of that covariate as well as how that effect might vary between clusters. So, if we want a measure of how an effect varies between clusters, one would use a random effect. Random effects can also be used to implicitly introduce a dependency structure within clusters. For instance, in the Ozempic example in Section <a href="#sec-oz"><span>Section&nbsp;1.1.2</span></a>, we saw that the random effect introduced a correlation between the observations coming from the same individual. Furthermore, modelling the intercept as a random effect allows us to estimate the average “regression line” for the population taking Ozempic, as well as how that “regression line” varies from person to person. (This will be made precise later if you missed the lecture.)</p>
<div id="exm-EX2" class="theorem example">
<p><span class="theorem-title"><strong>Example 1.5 </strong></span>A first example:</p>
<p>A clinical trial is set up to compare a new drug with a standard drug. The drug effect is of interest in the trial. We propose a Normal MLR (or fixed-effects) model with “drug” and “gender” as the two-fixed effects factors. Each has finite levels: “drug” – “new drug” and “standard drug”; “gender” – “female”,“male”, “non-binary”. Is there a cluster variable? Should we introduce any random effects?</p>
</div>
<div id="exm-EX3" class="theorem example">
<p><span class="theorem-title"><strong>Example 1.6 </strong></span>Clinical trial:</p>
<p>In a clinical trial, several hospitals in Canada are sampled. In each of the selected hospitals, a new treatment is compared with an existing treatment. Is there a cluster variable? Should we introduce any random effects? What definition(s) do any of these random effects fit?</p>
</div>
<p>One way to decide on whether an effect is a fixed or random effect is to ask if the observations for that covariate contain the complete set of levels we are interested in for a given covariate. In <a href="#exm-EX3">Example&nbsp;<span>1.6</span></a>, the data can be clustered by hospital. The treatment is a fixed effect, as we have observed the complete set of levels we are interested in for it. On the other hand, we would like our analysis to generalize beyond the selected hospitals, and so we would like to assess how the regression line varies between hospitals. This rule does not work well for continuous covariates, such as height, which may not require a random effect, but also, we cannot observe all levels of this factor.</p>
<div id="exm-EX4" class="theorem example">
<p><span class="theorem-title"><strong>Example 1.7 </strong></span>Antibiotics:</p>
<p>The efficacy an antibiotic maintains after it has been stored for two years is of scientific interest. Eight batches of the drug are selected at random from a population of available batches. From each batch, we take a sample of size two. The goal of the analysis: Estimate the overall mean concentration. Does the random batch have a significant effect on the variability of the responses?</p>
<table class="table">
<thead>
<tr class="header">
<th>batch</th>
<th>r1</th>
<th>r2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>40.00</td>
<td>42.00</td>
</tr>
<tr class="even">
<td>2</td>
<td>33.00</td>
<td>34.00</td>
</tr>
<tr class="odd">
<td>3</td>
<td>46.00</td>
<td>47.00</td>
</tr>
<tr class="even">
<td>4</td>
<td>55.00</td>
<td>52.00</td>
</tr>
<tr class="odd">
<td>5</td>
<td>63.00</td>
<td>59.00</td>
</tr>
<tr class="even">
<td>6</td>
<td>35.00</td>
<td>38.00</td>
</tr>
<tr class="odd">
<td>7</td>
<td>56.00</td>
<td>56.00</td>
</tr>
<tr class="even">
<td>8</td>
<td>34.00</td>
<td>29.00</td>
</tr>
</tbody>
</table>
<p>Since the batches are drawn randomly from a larger population, we could model the batch effect as a random effect. Obviously, the within batch observations will be correlated. The data are clustered by batch. Suppose instead that only eight batches exist in the whole world, and we are interested in knowing whether the batch number has an effect on the response. Then, the batch becomes a fixed effect.</p>
</div>
<div id="exm-EX5" class="theorem example">
<p><span class="theorem-title"><strong>Example 1.8 </strong></span>A Tale of Two Thieves (<span class="citation" data-cites="Cabrera2002">Cabrera and McDougall (<a href="references.html#ref-Cabrera2002" role="doc-biblioref">2002</a>)</span>):</p>
<p>Recall that the client wanted us to assess the level of active ingredient in their tablets, as well as assess the variability in that can be attributed to the sampling technique.</p>
<table class="table">
<thead>
<tr class="header">
<th></th>
<th>METHOD</th>
<th>LOCATION</th>
<th>REPLICATE</th>
<th>ASSAY</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>Intm</td>
<td>1</td>
<td>1</td>
<td>34.38</td>
</tr>
<tr class="even">
<td>2</td>
<td>Intm</td>
<td>1</td>
<td>2</td>
<td>34.87</td>
</tr>
<tr class="odd">
<td>3</td>
<td>Intm</td>
<td>1</td>
<td>3</td>
<td>35.71</td>
</tr>
<tr class="even">
<td>4</td>
<td>Intm</td>
<td>2</td>
<td>1</td>
<td>35.31</td>
</tr>
<tr class="odd">
<td>5</td>
<td>Intm</td>
<td>2</td>
<td>2</td>
<td>37.59</td>
</tr>
<tr class="even">
<td>6</td>
<td>Intm</td>
<td>2</td>
<td>3</td>
<td>38.02</td>
</tr>
</tbody>
</table>
<table class="table">
<thead>
<tr class="header">
<th>Number</th>
<th>methdb</th>
<th>drum</th>
<th>tablet</th>
<th>yb</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>Tablet</td>
<td>1</td>
<td>1</td>
<td>35.77</td>
</tr>
<tr class="even">
<td>2</td>
<td>Tablet</td>
<td>1</td>
<td>2</td>
<td>39.44</td>
</tr>
<tr class="odd">
<td>3</td>
<td>Tablet</td>
<td>1</td>
<td>3</td>
<td>36.43</td>
</tr>
<tr class="even">
<td>4</td>
<td>Tablet</td>
<td>5</td>
<td>1</td>
<td>35.71</td>
</tr>
<tr class="odd">
<td>5</td>
<td>Tablet</td>
<td>5</td>
<td>2</td>
<td>37.08</td>
</tr>
<tr class="even">
<td>6</td>
<td>Tablet</td>
<td>5</td>
<td>3</td>
<td>36.54</td>
</tr>
</tbody>
</table>
<p>What are the clusters? What might be a random effect?</p>
</div>
</section>
<section id="homework-questions-1" class="level3" data-number="1.2.2">
<h3 data-number="1.2.2" class="anchored" data-anchor-id="homework-questions-1"><span class="header-section-number">1.2.2</span> Homework questions</h3>
<ul>
<li>Give an example of a study where a mixed effect model would apply, which effects are random and which are fixed?</li>
<li>Describe the potential differences between a random and fixed effect. Compare and contrast the different definitions of random effects. Which one do you prefer and why?</li>
<li>How would you determine which definition for random effects a client is using?</li>
</ul>
</section>
<section id="regression-and-general-data-modelling-review" class="level3" data-number="1.2.3">
<h3 data-number="1.2.3" class="anchored" data-anchor-id="regression-and-general-data-modelling-review"><span class="header-section-number">1.2.3</span> Regression and general data modelling review</h3>
<p>By the end of this section, we will have covered all steps involved in analyzing data using mixed models:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<div>
<pre class="mermaid mermaid-js">flowchart LR
  A[Exploratory analysis] --&gt; B[Model specification]
  B --&gt; C{Estimation}
  C --&gt; D[Inference]
  D --&gt; E[Diagnostic plots]
  E --&gt; B
  E --&gt; F[Sensitivity testing]
</pre>
</div>
</div>
</div>
</div>
<div id="exm-reg_data" class="theorem example">
<p><span class="theorem-title"><strong>Example 1.9 </strong></span>How do you do each of these steps in a simple linear regression model?</p>
</div>
<p>Let’s review. Suppose <span class="math inline">\(Y_i\)</span> are continuous and we want to model <span class="math inline">\(E[Y_i |X_i ]\)</span>. A linear regression model takes <span class="math display">\[E[Y_i |X_i ] = X_i'\beta.\]</span> We take <span class="math inline">\(\hat\beta = (X'X)^{-1}X'Y\)</span>, and call these ordinary least squares (OLS) estimators. If <span class="math inline">\(Y_i |X_i \sim N(X_i'\beta,\sigma^2),\)</span> then the OLS estimators are the maximum likelihood estimators.</p>
<p>If we take <span class="math inline">\(Y_i = X_i'\beta + \epsilon_i\)</span> , where <span class="math inline">\(X_i\)</span> is non-normal, then the OLS estimators minimize the MSE of any predictor: <span class="math display">\[\phi(\beta)=\frac{1}{n}\sum_{i=1}^n ||\beta-E[Y_i |X_i ] ||^2\]</span> is minimized at <span class="math inline">\(\hat\beta\)</span>.</p>
<p>In this case, as discussed in Section <a href="#sec-mlr"><span>Section&nbsp;1.1.1</span></a>, we assume that:</p>
<ol type="1">
<li>The conditional mean is linear (in parameters).</li>
<li>All values of <span class="math inline">\(Y_i\)</span> have constant variance, denoted <span class="math inline">\(\sigma^2\)</span> (conditionally).</li>
<li>The <span class="math inline">\(Y_i\)</span> are independent.</li>
</ol>
<p>Then, one can show that <span class="math inline">\(\hat\beta\)</span> is asymptotically normal with <span class="math inline">\(Var(\hat\beta)=\sigma^2 (X'X)^{-1}\)</span>. We then use this fact to construct confidence intervals, hypothesis tests etc. We later analyze the residuals to diagnose any problems with the fit. Overall, linear regression allows us to estimate a functional form for the conditional mean of a continuous outcome. The ordinary least-squares estimators are valid MLE-type estimators when normality is assumed, and are least-squares estimators otherwise. The asymptotic analysis is valid in large samples, regardless of distributional assumptions. We now present equivalents of these results for the mixed model.</p>
</section>
<section id="defining-the-linear-mixed-model" class="level3" data-number="1.2.4">
<h3 data-number="1.2.4" class="anchored" data-anchor-id="defining-the-linear-mixed-model"><span class="header-section-number">1.2.4</span> Defining the linear mixed model</h3>
<p>Back to analyzing clustered data. Let’s start with longitudinal data, which could be represented by the following diagram: <img src="Plots/goal.PNG" class="img-fluid" style="width:80.0%" alt="goal"></p>
<p>In <span class="citation" data-cites="goal">(<a href="references.html#ref-goal" role="doc-biblioref"><strong>goal?</strong></a>)</span>, we see that there are time-varying and constant covariates, as well as the time-varying response. To formlize this, we can write:</p>
<ul>
<li><p><span class="math inline">\(Y_{ij}\)</span> response of subject <span class="math inline">\(i\)</span> at <span class="math inline">\(j\)</span>th time point for <span class="math inline">\(i\in[n]\)</span> and <span class="math inline">\(j\in[J_i]\)</span>.</p></li>
<li><p><span class="math inline">\(X_{ijk}\)</span> covariate <span class="math inline">\(k\)</span> of subject <span class="math inline">\(i\)</span> at <span class="math inline">\(j\)</span>th time point for <span class="math inline">\(k\in[K]\)</span>, <span class="math inline">\(i\in[n]\)</span> and <span class="math inline">\(j\in[J_i]\)</span>.</p></li>
<li><p><span class="math inline">\(X_{ij}\)</span> covariate vector for subject <span class="math inline">\(i\)</span> at <span class="math inline">\(j\)</span>th time point for <span class="math inline">\(i\in[n]\)</span> and <span class="math inline">\(j\in[J_i]\)</span>.</p></li>
<li><p><span class="math inline">\(t_{ij}\)</span> actual time for subject <span class="math inline">\(i\)</span> at time point <span class="math inline">\(j\)</span> for <span class="math inline">\(i\in[n]\)</span> and <span class="math inline">\(j\in[J_i]\)</span>.</p></li>
</ul>
<p>We can split the covariate matrix into time-varying covariates <span class="math inline">\(Z\)</span> and constant covariates <span class="math inline">\(W\)</span>. We have that <span class="math inline">\(X=[W|Z].\)</span> Each subject has <span class="math inline">\(J_i\)</span> rows in <span class="math inline">\(X\)</span> associated with it. Let <span class="math inline">\(X_{i}\)</span> be the <span class="math inline">\(J_i\times p\)</span> submatrix corresponding to the covariates for subject <span class="math inline">\(i\)</span> and let <span class="math inline">\(Z_i\)</span> be the <span class="math inline">\(J_i\times m\)</span> submatrix corresponding to the time-varying covariates for subject <span class="math inline">\(i\)</span>.</p>
<p>Now, the goal is to fit a model for <span class="math inline">\(E[Y_{ij} |X_{ij} , t_{ij} ]\)</span> with interpretable parameters.</p>
<p>To account for the correlation between subjects, we model the response as a vector <span class="math inline">\(Y_i\)</span>, where <span class="math display">\[Y_{i}=X_{i}\alpha+Z_{i}\beta_i+\epsilon_{i},\]</span> where</p>
<ul>
<li><p><span class="math inline">\(\alpha\)</span>: Population level effects – constant between subjects <span class="math inline">\((p\times 1)\)</span></p></li>
<li><p><span class="math inline">\(\beta_i\)</span>: Patient-level heterogeneity – varies between subjects <span class="math inline">\((m\times 1)\)</span></p></li>
<li><p><span class="math inline">\(\epsilon_{ij}\)</span>: Individual measurement variation – varies between measurements (scalars)</p></li>
</ul>
<p>Note that in the mixed model, we assume: <span class="math inline">\(\alpha\)</span> is a fixed vector, <span class="math inline">\(\beta_i\)</span> is randomly drawn for each individual, <span class="math inline">\(\epsilon_{ij}\)</span> are also randomly drawn.</p>
<p>We can then assume that <span class="math inline">\(\beta_i\sim N(0,\Sigma_\beta)\)</span>, <span class="math inline">\(\epsilon_{ij}\sim N(0,\sigma^2)\)</span> with <span class="math inline">\(\epsilon_{ij} \perp \beta_i\)</span>.</p>
<p>Now, let’s look at some properties of the model. Conditional on the random effects <span class="math display">\[E[Y_i |\beta_i,X_i ] = X_i\alpha + Z_i\beta_i\]</span> and <span class="math display">\[Cov(Y_i |\beta_i,X_i  ) = Cov(\epsilon_i|\beta_i,X_i ) = \sigma^2 I.\]</span> <strong>Derive these.</strong> If we consider the marginal distribution of <span class="math inline">\(Y_i\)</span> we find: <span class="math display">\[E[Y_i|X_i] = X_i\alpha \qquad \text{and}\qquad Cov(Y_i|X_i) = Z_i\Sigma_\beta Z_i'+\sigma^2 I\]</span> <strong>Derive this.</strong> Combining these results we find that, under this assumed model, <span class="math display">\[Y_i|X_i\sim N(X_i\alpha,Z_i\Sigma_\beta Z_i'+\sigma^2 I ).\]</span></p>
</section>
<section id="special-cases-of-single-layer-models" class="level3" data-number="1.2.5">
<h3 data-number="1.2.5" class="anchored" data-anchor-id="special-cases-of-single-layer-models"><span class="header-section-number">1.2.5</span> Special cases of single layer models</h3>
<p>We will now cover some special cases of the above model. The most basic mixed model is the random intercept model. Let <span class="math inline">\(\tilde{W}_i\)</span> be the covariate matrix of fixed effects with the intercept column removed. The resulting model is <span class="math display">\[Y_{i}=\alpha_1\mathbb{1}_{J_i}+\tilde{W}_{i}\alpha+\beta_i\mathbb{1}_{J_i}+\epsilon_{i},\]</span> where <span class="math inline">\(\beta_i\sim N(0,\sigma^2_\beta)\)</span> and <span class="math inline">\(\epsilon_{i}\sim N(0,\sigma^2 I_{J_i})\)</span>. For <span class="math inline">\(\ell\neq j\)</span>, it follows that <span class="math display">\[Corr(Y_{ij},Y_{i\ell})=\frac{\sigma^2_\beta}{\sigma^2_\beta+\sigma^2}.\]</span> The variance is constant across time or clusters: <span class="math inline">\(Cov(Y_i|X_i)=(\sigma^2_\beta+\sigma^2)I\)</span>. <strong>Derive these.</strong> Observe that in this model, all subject level regression lines are parallel. This can be used when we suspect that the correlation is constant over time, and only the mean response is thought to vary between clusters.</p>
<p>If instead, we would like the regression lines to vary in general between subjects, we can introduce slopes are random effects. This is the <strong>random intercept and slope model.</strong> Here, <span class="math display">\[
Y_{i }=\alpha_0\mathbb{1}_{J_i}+\widetilde{W}_{i} \alpha+\beta_{0i}\mathbb{1}_{J_i}+\alpha_1t_{i}+\beta_{1i}t_{i}+\epsilon_{i }.
\]</span> <strong>What is</strong> <span class="math inline">\(Z_i\)</span> here? The within-subject correlation will be time dependent in this model automatically, in this model, we assume that <span class="math inline">\(\beta_i=(\beta_{0i},\beta_{1i})'\sim N(0,\Sigma_\beta)\)</span>, where <span class="math display">\[
\Sigma_\beta=\left(\begin{array}{cc}
    \sigma^2_{\beta_0} &amp;   \sigma_{\beta_0,\beta_1} \\
     \sigma_{\beta_0,\beta_1}   &amp;   \sigma^2_{\beta_1}
\end{array}\right).
\]</span></p>
<p>Now, let’s understand some of the features of this model. For any <span class="math inline">\(i\in[n]\)</span>, we have that <span class="math display">\[Cov(Y_i|X_i) = Z_i\Sigma_\beta Z_i'+\sigma^2 I=(1_{J_i}\ t_i)\Sigma_\beta(1_{J_i}\ t_i)'+\sigma^2 I.\]</span> We see that the variance of the response is not constant across time. Further, for <span class="math inline">\(\ell\neq j\)</span>: <span class="math display">\[Cov(Y_{ij},Y_{i\ell})=\sigma^2_{\beta_0}+\sigma_{\beta_0,\beta_1}(t_{ij}+t_{i\ell})+\sigma^2_{\beta_1}t_{ij}t_{i\ell}.\]</span> In this model, the correlation between subject responses at different time points is varying.</p>
<p>Use the following code to explore how the correlation between time points changes as the distance between the time points grows.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>plot_cor<span class="ot">=</span><span class="cf">function</span>(matt){</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  Zi<span class="ot">=</span><span class="fu">cbind</span>(<span class="fu">rep</span>(<span class="dv">1</span>,<span class="dv">10</span>),<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># err=s</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  cov_mat<span class="ot">=</span>Zi<span class="sc">%*%</span>matt<span class="sc">%*%</span><span class="fu">t</span>(Zi)<span class="sc">+</span><span class="fu">diag</span>(<span class="fu">rep</span>(<span class="dv">1</span>,<span class="dv">10</span>))</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  cov_mat</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  vars<span class="ot">=</span><span class="fu">sqrt</span>(<span class="fu">diag</span>(cov_mat))</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  vars</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  corr_mat<span class="ot">=</span><span class="fu">apply</span>(cov_mat,<span class="dv">1</span>,<span class="st">"*"</span>,<span class="dv">1</span><span class="sc">/</span>vars)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  corr_mat<span class="ot">=</span><span class="fu">apply</span>(corr_mat,<span class="dv">1</span>,<span class="st">"*"</span>,<span class="dv">1</span><span class="sc">/</span>vars)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  corr_mat</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>,corr_mat[<span class="dv">1</span>,])</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>matt<span class="ot">=</span><span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="fl">0.4</span>,<span class="fl">0.4</span>,<span class="dv">1</span>),<span class="at">nrow=</span><span class="dv">2</span>)</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>matt<span class="ot">=</span><span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="fl">0.4</span>,<span class="fl">0.4</span>,<span class="dv">1</span>),<span class="at">nrow=</span><span class="dv">2</span>)</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>matt<span class="ot">=</span><span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">2</span>),<span class="at">nrow=</span><span class="dv">2</span>)</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>matt<span class="ot">=</span><span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">6</span>),<span class="at">nrow=</span><span class="dv">2</span>)</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>matt<span class="ot">=</span><span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="sc">-</span><span class="fl">0.9</span>,<span class="sc">-</span><span class="fl">0.9</span>,<span class="dv">4</span>),<span class="at">nrow=</span><span class="dv">2</span>)</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>matt<span class="ot">=</span><span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="fl">0.5</span>),<span class="at">nrow=</span><span class="dv">2</span>)</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_cor</span>(matt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="multi-level-models" class="level3" data-number="1.2.6">
<h3 data-number="1.2.6" class="anchored" data-anchor-id="multi-level-models"><span class="header-section-number">1.2.6</span> Multi-level models</h3>
<p>So far we have discussed single level mixed models, which do not admit a nested structure. In this way, there is a nested structure of clusters. For example, if we wanted to assess how a new way of teaching p-values affects statistical literacy, we could sample universities, then professors, then classes. Here, assuming professors teach multiple sections, we could assume that effects differ by university, by professor, and by class. We could write a mixed effect model with 3 levels as <span class="math display">\[\begin{align*}
Y_{ijk}&amp;=X_{ijk}\alpha+Z_{i,jk}\beta_i+Z_{ij,k}\beta_{ij}+Z_{ijk}\beta_{ijk}+\epsilon_{ijk}\\
&amp;i\in[n],\ j\in[J_i],\ k\in [m_{ij}],\\
&amp;\beta_i\sim N(0,\Sigma_1),\ \beta_{ij}\sim N(0,\Sigma_2),\ \beta_{ijk}\sim N(0,\Sigma_3),\ \epsilon_{ijk}\sim N(0,\sigma^2 I).
\end{align*}\]</span> Note that the “,” tells us which columns of the covariate matrix we are concerned with: <span class="math inline">\(Z_{i,jk}\)</span> denotes the covariates nested in the highest level, <span class="math inline">\(Z_{ij,k}\)</span> the second highest and <span class="math inline">\(Z_{ijk}\)</span> the inner-most level. For instance, with respect to the above example, <span class="math inline">\(Z_{i,jk}\)</span> would be the university level covariates. (Note that some books count the number of levels by the number of sources of random variation, which is 1+ the level definition used here.) In addition, <span class="citation" data-cites="Pinheiro2000">Pinheiro and Bates (<a href="references.html#ref-Pinheiro2000" role="doc-biblioref">2009</a>)</span> represents <span class="math inline">\(\Sigma_1\)</span> in form <span class="math inline">\(\Sigma_1^{-1}/\sigma^2=\Delta'\Delta\)</span>, where <span class="math inline">\(\Delta\)</span> is a non-unique relative precision factor. Specifications of the covariance matrices depend on the context. For more details, see <span class="citation" data-cites="Pinheiro2000">Pinheiro and Bates (<a href="references.html#ref-Pinheiro2000" role="doc-biblioref">2009</a>)</span>, <span class="citation" data-cites="Gelman2006">Gelman and Hill (<a href="references.html#ref-Gelman2006" role="doc-biblioref">2006</a>)</span>, <span class="citation" data-cites="Wu2019">Wu (<a href="references.html#ref-Wu2019" role="doc-biblioref">2019</a>)</span>.</p>
</section>
<section id="parameter-estimation-and-inference" class="level3" data-number="1.2.7">
<h3 data-number="1.2.7" class="anchored" data-anchor-id="parameter-estimation-and-inference"><span class="header-section-number">1.2.7</span> Parameter estimation and inference</h3>
<p>Generally, parameters are estimated with either maximum likelihood or restricted maximum likelihood (REML). Recall that this model is parametric, we have assumed normality. Thus, we can write down the likelihood. Let <span class="math inline">\(V_i=Cov(Y_i)=Z_i\Sigma_\beta Z_i'+\sigma^2 I\)</span>. Then, the (familiar) asymptotic result for both the MLE and the REML estimates: <span class="math display">\[\widehat{\alpha} \dot{\sim} N\left(\alpha\ ,\left[\sum_{i=1}^n X_i^{\prime} V_i^{-1} X_i\right]^{-1}\right),\]</span></p>
<p>where <span class="math inline">\(\dot{\sim}\)</span> denotes asymptotically distributed as. For more details on how to derive the estimates, see <span class="citation" data-cites="Pinheiro2000">Pinheiro and Bates (<a href="references.html#ref-Pinheiro2000" role="doc-biblioref">2009</a>)</span>.</p>
<p>Restricted maximum likelihood is used because the MLE biases the variance estimates downward. In REML, we maximize <span class="math display">\[\mathcal{L}(\Sigma_\beta,\sigma^2|y)=\int \mathcal{L}(\alpha,\Sigma_\beta,\sigma^2|y)d\alpha .\]</span> This constitutes a uniform prior on <span class="math inline">\(\alpha\)</span>. Note that REML estimates are not invariant under reparameterizations of the fixed effects – changing the units of the covariates <span class="math inline">\(X_i\)</span> units changes the estimates. As a result, LRT are not valid for testings significance of fixed effects – the restricted likelihoods cannot be compared to determine significance.</p>
<p><strong>Testing – Fixed effects – MLE:</strong> When using the MLEs, we can use likelihood ratio tests to test significance of various parameters. The parameters for the covariances, denoted <span class="math inline">\(\sigma_{\beta_k,\beta_\ell}\)</span>, will have some regularity concerns. Suppose we want to test whether a subset of the parameters are 0. Let <span class="math inline">\(k=\)</span># df in alt - # df in null. Recall that Wilks’ Theorem gives <span class="math inline">\(-2(\ell_1(\hat\theta)-\ell_0(\hat\theta))\sim \chi^2_{k}\)</span>, which can be used to conduct the test.</p>
<p><strong>Testing – Random effects:</strong> However, this does not apply to random effects. The variance parameters lie on the boundary of the parameter space, and so Wilks’ Theorem does not apply! Instead, we can simulate the distribution of the LRT statistic under the null and use the simulated distribution to obtain our critical value. If you are using a software where this is not feasible, then you can use <span class="math inline">\(\frac{1}{2} \chi^2_{\#\ RE\ Null}+\frac{1}{2} \chi^2_{\#\ RE\ ALT}.\)</span></p>
<p><strong>Testing – Fixed effects – REML:</strong> REML estimates are not invariant under reparameterizations of the fixed effects – changing the units for the covariates <span class="math inline">\(X_i\)</span> changes the REML estimates. As a result, LRT are not valid for testing the significance of fixed effects – the restricted likelihoods cannot be compared to determine significance. To test the fixed effects, we can use tests conditional on the variance parameters/RE parameters. In this case, we can perform either marginal <span class="math inline">\(t\)</span>-tests – tests which consider adding the parameter to the model with all other covariates, or sequential <span class="math inline">\(F\)</span>-tests – a test that adds the variables sequentially in the order they enter the model.</p>
<p><strong>Confidence intervals – Fixed effects – REML:</strong> Both REML and MLE give asymptotic normality of both <span class="math inline">\(\hat\sigma\)</span> and fixed effect estimates. This can be used to obtain confidence intervals. For the parameters contained in <span class="math inline">\(\Sigma_\beta\)</span>, constructing confidence intervals can be more difficult because <span class="math inline">\(\Sigma_\beta\)</span> must be positive definite, which restricts the parameter space. In this case, we transform the parameters so that they are unconstrained, compute the confidence interval, and transform the interval back. See Section 2.4 in “Mixed Models in S and S-plus” for more details <span class="citation" data-cites="Pinheiro2000">Pinheiro and Bates (<a href="references.html#ref-Pinheiro2000" role="doc-biblioref">2009</a>)</span>.</p>
</section>
<section id="individual-effects" class="level3" data-number="1.2.8">
<h3 data-number="1.2.8" class="anchored" data-anchor-id="individual-effects"><span class="header-section-number">1.2.8</span> Individual effects</h3>
<p>One thing we may want to do is produce an estimate of <span class="math inline">\(\beta_i\)</span> for observation <span class="math inline">\(i\)</span>. One may notice that <span class="math inline">\(E[\beta_i|Y_i]=\Sigma_\beta Z_i' V_i^{-1} (Y_i-X_i\alpha)\)</span>. Wait, we either know or have estimates of all of the values on the right-hand side. BLUP: <span class="math inline">\(\hat\beta_i=\hat\Sigma_\beta Z_i' \hat V_i^{-1} (Y_i-X_i\hat\alpha)\)</span>. Fitted values: <span class="math display">\[\hat Y_i=X_i\hat\alpha+Z_i\hat\beta_i.\]</span></p>
<p>Let’s analyze <span class="math inline">\(V_i\)</span>:</p>
<span class="math display">\[\begin{align*}
   V_i &amp;= Z_i \Sigma_\beta Z_i' + \sigma^2 I \\
   \implies V_i V_i^{-1} &amp;= Z_i \Sigma_\beta Z_i'V_i^{-1} + \sigma^2 I V_i^{-1} \\
   \implies I &amp;= Z_i \Sigma_\beta Z_i'V_i^{-1} + \sigma^2 V_i^{-1}.
\end{align*}\]</span>
<p>Now, the same logic gives that <span class="math display">\[I=Z_i \hat\Sigma_\beta Z_i'V_i^{-1}+\hat\sigma^2 V_i^{-1}.\]</span> We have <span class="math display">\[\begin{align*}
   \hat Y_i&amp;=X_i\hat\alpha+Z_i\hat\beta_i\\
  &amp;= X_i\hat\alpha+Z_i(\hat\Sigma_\beta Z_i' \hat V_i^{-1} (Y_i-X_i\hat\alpha))\\
   &amp;=(I-\hat\Sigma_\beta Z_i' \hat V_i^{-1}) X_i\hat\alpha+Z_i\hat\Sigma_\beta Z_i' \hat V_i^{-1} Y_i\\
   &amp;=\hat\sigma^2 \hat V_i^{-1} X_i\hat\alpha+(I-\hat\sigma^2\hat V_i^{-1}) Y_i\\
     &amp;=\hat\sigma^2 \hat V_i^{-1} X_i\hat\alpha+Z_i\hat\Sigma_\beta Z_i'V_i^{-1} Y_i.
\end{align*}\]</span> Thus, <span class="math display">\[\hat Y_i=\hat\sigma^2 \hat V_i^{-1} X_i\hat\alpha+Z_i\hat\Sigma_\beta Z_i'V_i^{-1} Y_i.\]</span> We have that:</p>
<ul>
<li><p><span class="math inline">\(\hat\sigma^2 I\)</span> within subject variation</p></li>
<li><p><span class="math inline">\(Z_i\hat\Sigma_\beta Z_i'\)</span> between subject variation</p></li>
<li><p>Higher within subject variation – more weight to the population average</p></li>
</ul>
</section>
<section id="exploratory-analysis-checking-assumptions-and-sensitivity-testing" class="level3" data-number="1.2.9">
<h3 data-number="1.2.9" class="anchored" data-anchor-id="exploratory-analysis-checking-assumptions-and-sensitivity-testing"><span class="header-section-number">1.2.9</span> Exploratory analysis, checking assumptions and sensitivity testing</h3>
<p><strong>Exploratory analysis:</strong> Prior to setting up our model, we would ideally conduct exploratory analysis. Here, we look for outliers, inconsistencies in the data, and try to ascertain the relationships between the provided variables. This will help inform the model we will choose. It is also helpful to check that the model results approximately mirror what we saw in the EDA, as a sanity check. Some tools you can use in EDA are:</p>
<ul>
<li>Descriptive statistics</li>
<li>xy plots – may have to subsample</li>
<li>Box plots by cluster variable</li>
<li>Cross-sectional plots</li>
</ul>
<p><strong>Diagnostic plots:</strong> These are used to check the fit of the model and check the assumptions. In a mixed model, we have independence and normality, and structure assumptions. This involves using graphics we are likely familiar with, such as qqplots. We may use:</p>
<ul>
<li>Checking independence between residuals across time – acf (may not be appropriate), variogram</li>
<li>We have independence and normality, and structure assumptions</li>
<li>Residuals vs.&nbsp;fitted values</li>
<li>qqplot of residuals/random effects for normality</li>
<li>Observed vs.&nbsp;fitted values</li>
</ul>
<p><strong>Sensitivity testing:</strong> In reality, there may be several models/frameworks with assumptions that could fit your data. For example, we may use a nonparametric method, a robust method, inclusion of different effects, use of different statistical tests. One thing you can do after performing a data analysis is to do the analysis under other models that may have been applied, and see if your results change. This helps support the conclusions made, and can reveal additional insights about your dataset. Be careful not to apply models whose assumptions are not reasonable for your data.</p>
</section>
<section id="homework-questions-2" class="level3" data-number="1.2.10">
<h3 data-number="1.2.10" class="anchored" data-anchor-id="homework-questions-2"><span class="header-section-number">1.2.10</span> Homework questions</h3>
<ul>
<li>How would you analyse the TLC data discussed last class? What are some statistical tests you might conduct?</li>
<li>Write down the likelihood function under the random intercept model.</li>
</ul>
</section>
</section>
<section id="case-study-batches-of-antibiotic-and-quality-control" class="level2" data-number="1.3">
<h2 data-number="1.3" class="anchored" data-anchor-id="case-study-batches-of-antibiotic-and-quality-control"><span class="header-section-number">1.3</span> Case study: Batches of antibiotic and quality control</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(nlme)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'lme4' was built under R version 4.2.3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: Matrix</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'lme4'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:nlme':

    lmList</code></pre>
</div>
</div>
<section id="case-information" class="level3" data-number="1.3.1">
<h3 data-number="1.3.1" class="anchored" data-anchor-id="case-information"><span class="header-section-number">1.3.1</span> Case information:</h3>
<ul>
<li>After an antibiotic has been stored for two years, it is of scientific interest to know what concentration of active ingredient is.</li>
<li>Eight batches of the drug are selected at random from a population of available batches.</li>
<li>From each batch, we take a sample of size two.</li>
<li>The goal of the analysis: Determine (to estimate) the overall mean concentration. A further question is whether or not the random batch has a significant effect on the variability of the responses.</li>
</ul>
<p>From 8 batches of antibiotics, 2 samples are drawn.</p>
<table class="table">
<thead>
<tr class="header">
<th>Batch</th>
<th>1</th>
<th>2</th>
<th>3</th>
<th>4</th>
<th>5</th>
<th>6</th>
<th>7</th>
<th>8</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Sample 1</td>
<td>40</td>
<td>33</td>
<td>46</td>
<td>55</td>
<td>63</td>
<td>35</td>
<td>56</td>
<td>34</td>
</tr>
<tr class="even">
<td>Sample 2</td>
<td>42</td>
<td>34</td>
<td>47</td>
<td>52</td>
<td>59</td>
<td>38</td>
<td>56</td>
<td>29</td>
</tr>
</tbody>
</table>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>batch<span class="ot">=</span><span class="fu">as.matrix</span>(<span class="fu">read.csv</span>(<span class="st">'data/batch.csv'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in read.table(file = file, header = header, sep = sep, quote = quote, :
incomplete final line found by readTableHeader on 'data/batch.csv'</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>batch<span class="ot">=</span><span class="fu">t</span>(batch)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>batch<span class="ot">=</span><span class="fu">unname</span>(batch)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>batch<span class="ot">=</span><span class="fu">data.frame</span>(<span class="fu">cbind</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>,batch))</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(batch)<span class="ot">=</span><span class="fu">c</span>(<span class="st">"batch"</span>,<span class="st">"r1"</span>,<span class="st">"r2"</span>)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>batch<span class="sc">$</span>r1<span class="ot">=</span><span class="fu">as.double</span>(batch<span class="sc">$</span>r1)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>batch<span class="sc">$</span>r2<span class="ot">=</span><span class="fu">as.double</span>(batch<span class="sc">$</span>r2)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>batch</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  batch r1 r2
1     1 40 42
2     2 33 34
3     3 46 47
4     4 55 52
5     5 63 59
6     6 35 38
7     7 56 56
8     8 34 29</code></pre>
</div>
</div>
<p>Overall mean: You can just take the sample mean here – the batches have an equal number of samples in each of the batches.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(<span class="fu">c</span>(batch<span class="sc">$</span>r1,batch<span class="sc">$</span>r2))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 44.9375</code></pre>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(batch)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     batch            r1              r2       
 Min.   :1.00   Min.   :33.00   Min.   :29.00  
 1st Qu.:2.75   1st Qu.:34.75   1st Qu.:37.00  
 Median :4.50   Median :43.00   Median :44.50  
 Mean   :4.50   Mean   :45.25   Mean   :44.62  
 3rd Qu.:6.25   3rd Qu.:55.25   3rd Qu.:53.00  
 Max.   :8.00   Max.   :63.00   Max.   :59.00  </code></pre>
</div>
</div>
<p>Graphically, the within batch variability is low relative to the between batch.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">cex.lab=</span><span class="dv">2</span>,<span class="at">cex.axis=</span><span class="dv">2</span>,<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(batch<span class="sc">$</span>batch,batch<span class="sc">$</span>r1,<span class="at">pch=</span><span class="dv">21</span>,<span class="at">bg=</span><span class="dv">1</span>,<span class="at">cex=</span><span class="dv">2</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(batch<span class="sc">$</span>batch,batch<span class="sc">$</span>r2,<span class="at">pch=</span><span class="dv">21</span>,<span class="at">bg=</span><span class="dv">1</span>,<span class="at">cex=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/EDA 31-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(batch<span class="sc">$</span>r1,batch<span class="sc">$</span>r2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.9672002</code></pre>
</div>
</div>
<p>Okay what about a confidence intervals for the mean? What about whether or not the random batch has a significant effect on the variability of the responses? We need a model for this.</p>
<p>It appears that the within batch mean is not constant.</p>
<p><span class="math display">\[Y_{ij}=\mu+\beta_i+\epsilon_{ij},\]</span> where for <span class="math inline">\(i\in[8]\)</span> and <span class="math inline">\(j\in[2]\)</span>, we have</p>
<ul>
<li><span class="math inline">\(Y_{ij}\)</span>: concentration</li>
<li><span class="math inline">\(\mu\)</span>: overall mean</li>
<li><span class="math inline">\(\beta_i\)</span>: effect of batch <span class="math inline">\(i\)</span>, this effect is random!</li>
<li><span class="math inline">\(\epsilon_{ij}\)</span> random error</li>
</ul>
<p>The assumptions are</p>
<ul>
<li><span class="math inline">\(\beta_i\sim N(0,\sigma^2_b)\)</span> iid</li>
<li><span class="math inline">\(\epsilon_{ij}\sim N(0,\sigma^2)\)</span> iid</li>
<li><span class="math inline">\(\beta_i\)</span> is independent of <span class="math inline">\(\epsilon_{ij}\)</span></li>
</ul>
<p>Under these assumptions <span class="math inline">\(E(Y_{ij})=\mu\)</span> and <span class="math inline">\(Var(Y_{ij})=\sigma^2+\sigma_b^2.\)</span></p>
<p>In addition, we see that we capture the dependence structure: One can check that</p>
<ul>
<li><span class="math inline">\(Cov(Y_{i1},Y_{i2})=\sigma_b^2\)</span></li>
<li><span class="math inline">\(Cov(Y_{i1},Y_{i'1})=0\)</span></li>
</ul>
<p>Recall we are interested in whether or not the random batch has a significant effect on the variability of the responses. This means we would like to estimate <span class="math inline">\(\sigma_b\)</span> and test if it is negligible.</p>
<p>Let’s estimate the parameters of this model. The relevant R package for (generalised) linear mixed models in R are <code>nlme</code>, <code>lme4</code> and <code>lmerTest</code>. Let’s use REML to estimate our parameters.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co">#We need to reshape this data into long format!</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>batch_long<span class="ot">=</span><span class="fu">reshape</span>(batch, </span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>                   <span class="at">varying=</span><span class="fu">c</span>(<span class="st">'r1'</span>,<span class="st">'r2'</span>), </span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>                   <span class="at">timevar =</span> <span class="st">'replicate'</span>,</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>                   <span class="at">idvar =</span> <span class="st">'batch'</span>,</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>                   <span class="at">times=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>),</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>                   <span class="at">direction =</span> <span class="st">"long"</span>,<span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(batch_long)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    batch replicate  r
1.1     1         1 40
2.1     2         1 33
3.1     3         1 46
4.1     4         1 55
5.1     5         1 63
6.1     6         1 35</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co">#using other package</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="co"># fit.lme&lt;-lme4::lmer(r ~ 1 | batch, data=batch_long)</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="co"># summary(fit.lme)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(batch_long) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="co">#defaults to REML</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>model_1<span class="ot">=</span><span class="fu">lme</span>(</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">fixed=</span> r<span class="sc">~</span><span class="dv">1</span>,</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">random=</span>  <span class="sc">~</span> <span class="dv">1</span> <span class="sc">|</span> batch, <span class="at">data=</span>batch_long )</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed-effects model fit by REML
  Data: batch_long 
       AIC      BIC    logLik
  101.0371 103.1613 -47.51855

Random effects:
 Formula: ~1 | batch
        (Intercept) Residual
StdDev:    10.95445 2.015565

Fixed effects:  r ~ 1 
              Value Std.Error DF  t-value p-value
(Intercept) 44.9375  3.905623  8 11.50585       0

Standardized Within-Group Residuals:
        Min          Q1         Med          Q3         Max 
-1.35131912 -0.56486600  0.09135863  0.51634786  1.12937443 

Number of Observations: 16
Number of Groups: 8 </code></pre>
</div>
</div>
<p>Okay, between batch variance is huge. Let’s test if its non-zero anyways. Recall that for REML estimates, the asymptotic distribution for the LRT is not the same as usual. In this case, under the null hypothesis, <span class="math inline">\(Y_{ij}\sim N(\mu,\sigma^2)\)</span>.</p>
<p>Therefore, in order to construct a hypothesis test for <span class="math inline">\(\sigma^2_\beta\)</span>, we can do the following:</p>
<ol type="1">
<li>Compute the LRT statistic from the sample, call it <span class="math inline">\(\hat T\)</span>.</li>
<li>Simulate many, say <span class="math inline">\(n_{sim}\)</span>, new samples of the same size from the model <span class="math inline">\(Y_{ij}\sim N(\mu,\sigma^2)\)</span>.</li>
<li>For each of the <span class="math inline">\(n_{sim}\)</span> samples, compute the LRT statistic: <span class="math inline">\(\tilde T_1,\ldots,\tilde T_{n_{sim}}\)</span>.</li>
<li>The (empirical) p-value is then the proportion of <span class="math inline">\(\tilde T_1,\ldots,\tilde T_{n_{sim}}\)</span> larger than <span class="math inline">\(\hat T\)</span>.</li>
</ol>
<p>Thus,</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Step 1. Computing T-hat</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>fit_null<span class="ot">&lt;-</span><span class="fu">lm</span>(r <span class="sc">~</span> <span class="dv">1</span> , <span class="at">data=</span>batch_long)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>observed<span class="ot">=</span>lmtest<span class="sc">::</span><span class="fu">lrtest</span>(fit_null,model_1)<span class="sc">$</span>Chisq[<span class="dv">2</span>]; observed</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in modelUpdate(objects[[i - 1]], objects[[i]]): original model was of
class "lm", updated model is of class "lme"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 25.40237</code></pre>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Step 2. </span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="co">#Get the fixed effects</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>fe<span class="ot">=</span>nlme<span class="sc">::</span><span class="fu">fixed.effects</span>(model_1); fe</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept) 
    44.9375 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Get the estimated variance of the RE</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>sigma_batch_est<span class="ot">=</span> nlme<span class="sc">::</span><span class="fu">getVarCov</span>(model_1); sigma_batch_est</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Random effects variance covariance matrix
            (Intercept)
(Intercept)         120
  Standard Deviations: 10.954 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Get the estimate of sigma</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>sigma_est<span class="ot">=</span>model_1<span class="sc">$</span>sigma; sigma_est</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2.015565</code></pre>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>n<span class="ot">=</span><span class="fu">nrow</span>(batch_long)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>n_sim<span class="ot">=</span><span class="dv">100</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="co">#Step 2 </span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>simulated<span class="ot">=</span><span class="fu">t</span>(<span class="fu">replicate</span>(n_sim,<span class="fu">rnorm</span>(n,fe[<span class="dv">1</span>],sigma_est)))</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a><span class="co"># n_sim x 16</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(simulated)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 100  16</code></pre>
</div>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Step 3</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="co">#takes a simulated sample y and computes the LRT for Y</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>compute_lrt<span class="ot">=</span><span class="cf">function</span>(y){</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">#create a copy of the dataset</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>  batch_copy<span class="ot">=</span>batch_long</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">#replace response with new sample</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>  batch_copy<span class="sc">$</span>r<span class="ot">=</span>y</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">#replace response with new sampl</span></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>  alt<span class="ot">=</span><span class="fu">lme</span>(</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">fixed=</span> r<span class="sc">~</span><span class="dv">1</span>,</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">random=</span> r <span class="sc">~</span> <span class="dv">1</span> <span class="sc">|</span> batch, <span class="at">data=</span>batch_copy )</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>  null<span class="ot">&lt;-</span><span class="fu">lm</span>(r <span class="sc">~</span> <span class="dv">1</span> , <span class="at">data=</span>batch_copy)</span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>  test<span class="ot">=</span>lmtest<span class="sc">::</span><span class="fu">lrtest</span>(null,alt)<span class="sc">$</span>Chisq[<span class="dv">2</span>]</span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(test)</span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a><span class="co">#compute LRT for each simulated sample </span></span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a>ts<span class="ot">=</span><span class="fu">suppressWarnings</span>(<span class="fu">apply</span>(simulated, <span class="dv">1</span>, compute_lrt))</span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a>pvalue<span class="ot">=</span><span class="fu">mean</span>(observed<span class="sc">&lt;=</span>ts); pvalue</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(ts,<span class="at">xlim=</span><span class="fu">c</span>(<span class="fu">min</span>(ts),<span class="dv">29</span>))</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v=</span>observed)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/Testing Batch-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>observed</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 25.40237</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model_1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/GOF 8-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">qqnorm</span>(model_1, <span class="sc">~</span> <span class="fu">residuals</span>(.,<span class="at">type=</span><span class="st">"pearson"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/GOF 8-2.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">ranef</span>(model_1))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/GOF 8-3.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">fixef</span>(model_1))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/GOF 8-4.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">qqnorm</span>(model_1, <span class="sc">~</span> <span class="fu">ranef</span>(.))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/GOF 8-5.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model_1, r <span class="sc">~</span> <span class="fu">fitted</span>(.),<span class="at">abline=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/GOF 8-6.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">intervals</span>(model_1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Approximate 95% confidence intervals

 Fixed effects:
               lower    est.    upper
(Intercept) 35.93112 44.9375 53.94388

 Random Effects:
  Level: batch 
                   lower     est.    upper
sd((Intercept)) 6.430117 10.95445 18.66216

 Within-group standard error:
   lower     est.    upper 
1.234790 2.015565 3.290036 </code></pre>
</div>
</div>
<p>Results summary:</p>
<ul>
<li>Quick summary: the mean is estimated to be 45, and we saw significant variation between batches. The batch mean concentration has standard deviation 11.</li>
<li>More on the mean: The mean concentration is estimated to be 45, at least, we estimate that the mean concentration is not below 36 and does not exceed 54.</li>
<li>Batch variability: The concentration varies significantly between batches. The standard deviation of the mean batch concentration is estimated to be 12, ranging from (6,19). This means we estimate that roughly 68% of the batches have a mean concentration within 11 units of the overall mean (estimated to be 45) and 95% are within 22 units of the overall mean.</li>
</ul>
</section>
</section>
<section id="case-study-air-pollution" class="level2" data-number="1.4">
<h2 data-number="1.4" class="anchored" data-anchor-id="case-study-air-pollution"><span class="header-section-number">1.4</span> Case study: Air Pollution</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(nlme)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="case-information-1" class="level3" data-number="1.4.1">
<h3 data-number="1.4.1" class="anchored" data-anchor-id="case-information-1"><span class="header-section-number">1.4.1</span> Case information:</h3>
<ul>
<li>Six Cities Air Pollution Data – Data on lung growth along with assorted patient information.</li>
<li>How much of lung size do age and height explain?</li>
</ul>
<p>Data Columns:</p>
<ul>
<li>id: Patient ID</li>
<li>ht: Patient height at the corresponding visit</li>
<li>age: Patient age</li>
<li>baseht: Patient height at the first visit</li>
<li>baseage: Patient age at the first visit</li>
<li>logfev1: The log of FEV1 measurement (outcome based on lung function)</li>
</ul>
<p>Data Info:</p>
<ul>
<li>https://content.sph.harvard.edu/fitzmaur/ala2e/</li>
<li>Applied LDA: Garrett Fitzmaurice, Nan Laird &amp; James Ware</li>
<li>Dockery, D.W., Berkey, C.S., Ware, J.H., Speizer, F.E. and Ferris, B.G. (1983). Distribution of FVC and FEV1 in children 6 to 11 years old. American Review of Respiratory Disease, 128, 405-412.</li>
</ul>
</section>
<section id="eda" class="level3" data-number="1.4.2">
<h3 data-number="1.4.2" class="anchored" data-anchor-id="eda"><span class="header-section-number">1.4.2</span> EDA:</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>air_pollution <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/air_pollution.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s explore the data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">cex.lab=</span><span class="dv">2</span>,<span class="at">cex.axis=</span><span class="dv">2</span>,<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(air_pollution)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  id   ht     age baseht baseage logfev1
1  1 1.20  9.3415    1.2  9.3415 0.21511
2  1 1.28 10.3929    1.2  9.3415 0.37156
3  1 1.33 11.4524    1.2  9.3415 0.48858
4  1 1.42 12.4600    1.2  9.3415 0.75142
5  1 1.48 13.4182    1.2  9.3415 0.83291
6  1 1.50 15.4743    1.2  9.3415 0.89200</code></pre>
</div>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(air_pollution)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       id              ht             age             baseht     
 Min.   :  1.0   Min.   :1.110   Min.   : 6.434   Min.   :1.110  
 1st Qu.: 69.0   1st Qu.:1.370   1st Qu.: 9.719   1st Qu.:1.220  
 Median :129.0   Median :1.540   Median :12.597   Median :1.260  
 Mean   :135.7   Mean   :1.498   Mean   :12.568   Mean   :1.276  
 3rd Qu.:199.0   3rd Qu.:1.620   3rd Qu.:15.368   3rd Qu.:1.320  
 Max.   :300.0   Max.   :1.790   Max.   :18.691   Max.   :1.720  
    baseage          logfev1        
 Min.   : 6.434   Min.   :-0.04082  
 1st Qu.: 7.135   1st Qu.: 0.54812  
 Median : 7.781   Median : 0.86710  
 Mean   : 8.030   Mean   : 0.81600  
 3rd Qu.: 8.449   3rd Qu.: 1.09861  
 Max.   :14.067   Max.   : 1.59534  </code></pre>
</div>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Check for missing values</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="fu">colSums</span>(<span class="fu">is.na</span>(air_pollution))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     id      ht     age  baseht baseage logfev1 
      0       0       0       0       0       0 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">unique</span>(air_pollution<span class="sc">$</span>baseht)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 1.20 1.13 1.18 1.15 1.11 1.24 1.27 1.17 1.32 1.26 1.25 1.19 1.21 1.23 1.22
[16] 1.30 1.37 1.41 1.14 1.29 1.31 1.28 1.36 1.33 1.38 1.12 1.35 1.34 1.45 1.39
[31] 1.16 1.58 1.60 1.40 1.42 1.72 1.46 1.48 1.52 1.49 1.56 1.53 1.43 1.44 1.59
[46] 1.57</code></pre>
</div>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Is it balanced?</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>n<span class="ot">=</span><span class="fu">length</span>(<span class="fu">unique</span>(air_pollution<span class="sc">$</span>id))</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="co"># typeof(air_pollution$id)</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a><span class="fu">barplot</span>(<span class="fu">table</span>(<span class="fu">as.factor</span>(air_pollution<span class="sc">$</span>id)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/EDA Air Pollution-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(air_pollution[,<span class="sc">-</span><span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/EDA Air Pollution 2-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(air_pollution<span class="sc">$</span>baseage)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/EDA Air Pollution 2-2.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(air_pollution<span class="sc">$</span>baseht)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/EDA Air Pollution 2-3.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co"># hist(air_pollution$age)</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="co"># hist(air_pollution$ht)</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a><span class="co">#Hint: height has been shown to be linearly associated with logfev1 on log scale</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>air_pollution<span class="sc">$</span>loght<span class="ot">=</span><span class="fu">log</span>(air_pollution<span class="sc">$</span>ht)</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>air_pollution<span class="sc">$</span>logbht<span class="ot">=</span><span class="fu">log</span>(air_pollution<span class="sc">$</span>baseht)</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(air_pollution[,<span class="fu">c</span>(<span class="st">'age'</span>,<span class="st">'loght'</span>,<span class="st">'logfev1'</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/EDA Air Pollution 2-4.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(air_pollution[,<span class="fu">c</span>(<span class="st">'age'</span>,<span class="st">'ht'</span>,<span class="st">'logfev1'</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/EDA Air Pollution 2-5.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">5</span>))</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>bx<span class="ot">=</span><span class="fu">apply</span>(air_pollution[,<span class="fu">c</span>(<span class="st">'age'</span>,<span class="st">'baseage'</span>,<span class="st">'logbht'</span>,<span class="st">'loght'</span>,<span class="st">'logfev1'</span>)],<span class="dv">2</span>,boxplot)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/EDA Air Pollution 2-6.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>lattice<span class="sc">::</span><span class="fu">xyplot</span>(logfev1<span class="sc">~</span>age, air_pollution, <span class="at">col =</span> <span class="st">'black'</span>, <span class="at">type =</span> <span class="fu">c</span>(<span class="st">'l'</span>, <span class="st">'p'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/EDA Air Pollution 2-7.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>lattice<span class="sc">::</span><span class="fu">xyplot</span>(logfev1<span class="sc">~</span>age, air_pollution[ air_pollution<span class="sc">$</span>id <span class="sc">%in%</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span>n,<span class="dv">10</span>),], <span class="at">col =</span> <span class="st">'black'</span>, <span class="at">type =</span> <span class="fu">c</span>(<span class="st">'l'</span>, <span class="st">'p'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/EDA Air Pollution 2-8.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>lattice<span class="sc">::</span><span class="fu">xyplot</span>(logfev1<span class="sc">~</span>age, air_pollution[ air_pollution<span class="sc">$</span>id <span class="sc">%in%</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span>n,<span class="dv">10</span>),], <span class="at">col =</span> <span class="st">'black'</span>, <span class="at">type =</span> <span class="fu">c</span>(<span class="st">'l'</span>, <span class="st">'p'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/EDA Air Pollution 2-9.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>lattice<span class="sc">::</span><span class="fu">xyplot</span>(logfev1<span class="sc">~</span><span class="fu">log</span>(ht), air_pollution, <span class="at">col =</span> <span class="st">'black'</span>, <span class="at">type =</span> <span class="fu">c</span>(<span class="st">'l'</span>, <span class="st">'p'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/EDA Air Pollution 2-10.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>What can we conclude from this exploratory analysis?</p>
<ul>
<li>300 participants</li>
<li>No missing values</li>
<li>Not balanced</li>
<li>Starting age ranges widely</li>
<li>Somewhat linear relationships with the response, but not quite.</li>
<li>Log scale might be better for height</li>
<li>Heavy tail in base age, and base height.</li>
<li>Parallel regression line between response and age</li>
</ul>
</section>
<section id="specifying" class="level3" data-number="1.4.3">
<h3 data-number="1.4.3" class="anchored" data-anchor-id="specifying"><span class="header-section-number">1.4.3</span> Specifying</h3>
<ul>
<li>Let <span class="math inline">\(i\)</span> index the individuals and <span class="math inline">\(j\)</span> index the <span class="math inline">\(j\)</span>th age recorded for a given individual.</li>
</ul>
<p><span class="math display">\[Y_{ij}=\mu+W_i\alpha+Z_i\beta_i+\epsilon_{ij},\]</span> where for <span class="math inline">\(i\in[299]\)</span> and <span class="math inline">\(j\in [J_i]\)</span>.</p>
<p>Here,</p>
<ul>
<li><span class="math inline">\(Z_i=(1 , age )\)</span>, <span class="math inline">\(W_i=(1 , age , loght ...)\)</span></li>
<li>Each observation has a random intercept and slope, which depends on their age.</li>
</ul>
</section>
<section id="estimation" class="level3" data-number="1.4.4">
<h3 data-number="1.4.4" class="anchored" data-anchor-id="estimation"><span class="header-section-number">1.4.4</span> Estimation</h3>
<p>Let’s estimate the parameters of this model. Let’s use REML to estimate our parameters.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co">#defaults to REML</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">lme</span>(</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">fixed =</span> logfev1 <span class="sc">~</span> age <span class="sc">+</span> <span class="fu">log</span>(ht) <span class="sc">+</span> baseage <span class="sc">+</span> <span class="fu">log</span>(baseht) ,</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">random =</span><span class="sc">~</span>age<span class="sc">|</span>id,</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">correlation =</span> <span class="cn">NULL</span>, <span class="co"># Defaults to sigma^2 I </span></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> <span class="st">'REML'</span>,</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> air_pollution</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed-effects model fit by REML
  Data: air_pollution 
        AIC       BIC   logLik
  -4549.882 -4499.528 2283.941

Random effects:
 Formula: ~age | id
 Structure: General positive-definite, Log-Cholesky parametrization
            StdDev      Corr  
(Intercept) 0.110485541 (Intr)
age         0.007078381 -0.553
Residual    0.060237881       

Fixed effects:  logfev1 ~ age + log(ht) + baseage + log(baseht) 
                 Value  Std.Error   DF  t-value p-value
(Intercept) -0.2883233 0.03871675 1692 -7.44699  0.0000
age          0.0235286 0.00139534 1692 16.86231  0.0000
log(ht)      2.2371984 0.04353724 1692 51.38585  0.0000
baseage     -0.0165088 0.00745785  296 -2.21362  0.0276
log(baseht)  0.2182148 0.14552087  296  1.49954  0.1348
 Correlation: 
            (Intr) age    lg(ht) baseag
age          0.023                     
log(ht)     -0.077 -0.875              
baseage     -0.822 -0.184  0.180       
log(baseht)  0.370  0.239 -0.275 -0.815

Standardized Within-Group Residuals:
        Min          Q1         Med          Q3         Max 
-6.45672792 -0.52534885  0.05351814  0.60114614  2.76671671 

Number of Observations: 1993
Number of Groups: 299 </code></pre>
</div>
</div>
</section>
<section id="testing" class="level3" data-number="1.4.5">
<h3 data-number="1.4.5" class="anchored" data-anchor-id="testing"><span class="header-section-number">1.4.5</span> Testing</h3>
<p>Do we need the baseline fixed effects? Did the height and age they entered the study at effect the outcome?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co">#marginal tests:</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed-effects model fit by REML
  Data: air_pollution 
        AIC       BIC   logLik
  -4549.882 -4499.528 2283.941

Random effects:
 Formula: ~age | id
 Structure: General positive-definite, Log-Cholesky parametrization
            StdDev      Corr  
(Intercept) 0.110485541 (Intr)
age         0.007078381 -0.553
Residual    0.060237881       

Fixed effects:  logfev1 ~ age + log(ht) + baseage + log(baseht) 
                 Value  Std.Error   DF  t-value p-value
(Intercept) -0.2883233 0.03871675 1692 -7.44699  0.0000
age          0.0235286 0.00139534 1692 16.86231  0.0000
log(ht)      2.2371984 0.04353724 1692 51.38585  0.0000
baseage     -0.0165088 0.00745785  296 -2.21362  0.0276
log(baseht)  0.2182148 0.14552087  296  1.49954  0.1348
 Correlation: 
            (Intr) age    lg(ht) baseag
age          0.023                     
log(ht)     -0.077 -0.875              
baseage     -0.822 -0.184  0.180       
log(baseht)  0.370  0.239 -0.275 -0.815

Standardized Within-Group Residuals:
        Min          Q1         Med          Q3         Max 
-6.45672792 -0.52534885  0.05351814  0.60114614  2.76671671 

Number of Observations: 1993
Number of Groups: 299 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="co">#sequential tests: </span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            numDF denDF   F-value p-value
(Intercept)     1  1692 11406.811  &lt;.0001
age             1  1692 16605.209  &lt;.0001
log(ht)         1  1692  2905.336  &lt;.0001
baseage         1   296     2.929  0.0881
log(baseht)     1   296     2.249  0.1348</code></pre>
</div>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co">#based on the above, lets remove the base effects</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>model<span class="ot">=</span><span class="fu">update</span>(model,<span class="at">fixed=</span> logfev1 <span class="sc">~</span> age<span class="sc">+</span><span class="fu">log</span>(ht))</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed-effects model fit by REML
  Data: air_pollution 
        AIC       BIC   logLik
  -4559.789 -4520.618 2286.895

Random effects:
 Formula: ~age | id
 Structure: General positive-definite, Log-Cholesky parametrization
            StdDev     Corr  
(Intercept) 0.11107952 (Intr)
age         0.00706045 -0.552
Residual    0.06025488       

Fixed effects:  logfev1 ~ age + log(ht) 
                 Value  Std.Error   DF   t-value p-value
(Intercept) -0.3693653 0.00916684 1692 -40.29366       0
age          0.0230800 0.00135469 1692  17.03715       0
log(ht)      2.2493934 0.04176179 1692  53.86247       0
 Correlation: 
        (Intr) age   
age     -0.208       
log(ht) -0.190 -0.869

Standardized Within-Group Residuals:
        Min          Q1         Med          Q3         Max 
-6.44851637 -0.51754969  0.05387027  0.59382767  2.78517863 

Number of Observations: 1993
Number of Groups: 299 </code></pre>
</div>
</div>
<p>Can the random slope be dropped?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>model_null<span class="ot">=</span><span class="fu">update</span>(model,<span class="at">random=</span>logfev1 <span class="sc">~</span> <span class="dv">1</span><span class="sc">|</span>id)</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_null)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed-effects model fit by REML
  Data: air_pollution 
        AIC       BIC   logLik
  -4489.806 -4461.827 2249.903

Random effects:
 Formula: logfev1 ~ 1 | id
        (Intercept)   Residual
StdDev:  0.09608834 0.06429074

Fixed effects:  logfev1 ~ age + log(ht) 
                 Value  Std.Error   DF   t-value p-value
(Intercept) -0.3645554 0.00833614 1692 -43.73192       0
age          0.0237689 0.00126198 1692  18.83462       0
log(ht)      2.2162876 0.04195216 1692  52.82893       0
 Correlation: 
        (Intr) age   
age     -0.048       
log(ht) -0.218 -0.928

Standardized Within-Group Residuals:
        Min          Q1         Med          Q3         Max 
-6.00485051 -0.54072380  0.06768753  0.61714951  2.86626992 

Number of Observations: 1993
Number of Groups: 299 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>LRT<span class="ot">=</span><span class="fu">anova</span>(model_null,model)<span class="sc">$</span>L[<span class="dv">2</span>]; LRT</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 73.98299</code></pre>
</div>
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>simmed<span class="ot">=</span>nlme<span class="sc">::</span><span class="fu">simulate.lme</span>(model_null,<span class="at">nsim=</span><span class="dv">100</span>,<span class="at">m2=</span>model)</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>sim_LRT<span class="ot">=</span><span class="sc">-</span><span class="dv">2</span><span class="sc">*</span>(simmed<span class="sc">$</span>null<span class="sc">$</span>REML[,<span class="dv">2</span>]<span class="sc">-</span>simmed<span class="sc">$</span>alt<span class="sc">$</span>REML[,<span class="dv">2</span>])</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>pval<span class="ot">=</span><span class="fu">mean</span>(LRT<span class="sc">&gt;=</span>sim_LRT); <span class="fu">print</span>(pval)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(sim_LRT)</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v=</span>LRT)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/Testing 22-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(model_null,model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           Model df       AIC       BIC   logLik   Test  L.Ratio p-value
model_null     1  5 -4489.806 -4461.827 2249.903                        
model          2  7 -4559.789 -4520.618 2286.894 1 vs 2 73.98299  &lt;.0001</code></pre>
</div>
</div>
</section>
<section id="diagnostics" class="level3" data-number="1.4.6">
<h3 data-number="1.4.6" class="anchored" data-anchor-id="diagnostics"><span class="header-section-number">1.4.6</span> Diagnostics</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="do">## ACF - Checks that errors are independent</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">ACF</span>(model), <span class="at">alpha =</span> <span class="fl">0.01</span>, <span class="at">main =</span> <span class="st">"ACF plot for independent errors."</span>) <span class="co"># This looks problematic!</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/GOF 1-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This may not be the best way to check the model fit though, since there are not evenly spaced errors...</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Instead we can use a 'semi-Variogram'. </span></span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a><span class="co"># This should fluctuate randomly around 1</span></span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>vg <span class="ot">&lt;-</span> <span class="fu">Variogram</span>(model, <span class="at">form =</span> <span class="sc">~</span>age<span class="sc">|</span>id, <span class="at">resType =</span> <span class="st">"pearson"</span>)</span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(vg, <span class="at">sigma=</span><span class="dv">1</span>) <span class="do">## Looks okay, honestly, not the best.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/GOF 1-2.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Residuals vs. Fitted (no patterns)</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model, <span class="at">main =</span> <span class="st">"Plot of residuals vs. fitted."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/GOF 1-3.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="co"># QQPlot for normality of errors</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a><span class="fu">qqnorm</span>(model, <span class="sc">~</span> <span class="fu">residuals</span>(., <span class="at">type=</span><span class="st">"pearson"</span>)) <span class="co"># Some issues... probably</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/GOF 1-4.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plots for the Predicted (BLUPs)</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">ranef</span>(model)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/GOF 1-5.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="fu">qqnorm</span>(model, <span class="sc">~</span><span class="fu">ranef</span>(.)) <span class="co"># These look okay!</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/GOF 1-6.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Observed vs. Fitted</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model, logfev1 <span class="sc">~</span> <span class="fu">fitted</span>(.), <span class="at">abline =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">main =</span> <span class="st">"Observed vs. Fitted"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/GOF 1-7.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model, logfev1 <span class="sc">~</span> <span class="fu">fitted</span>(.)<span class="sc">|</span>id, <span class="at">abline =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">main =</span> <span class="st">"Observed vs. Fitted (By Subject)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/GOF 1-8.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Could also look (e.g.) by treatment, if it existed!</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a><span class="do">### Intervals</span></span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a><span class="fu">intervals</span>(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Approximate 95% confidence intervals

 Fixed effects:
                 lower        est.       upper
(Intercept) -0.3873448 -0.36936532 -0.35138579
age          0.0204230  0.02308004  0.02573708
log(ht)      2.1674832  2.24939340  2.33130360

 Random Effects:
  Level: id 
                            lower        est.        upper
sd((Intercept))       0.095315000  0.11107952  0.129451390
sd(age)               0.005828914  0.00706045  0.008552184
cor((Intercept),age) -0.685485568 -0.55220425 -0.383114275

 Within-group standard error:
     lower       est.      upper 
0.05812314 0.06025488 0.06246480 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="fu">intervals</span>(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Approximate 95% confidence intervals

 Fixed effects:
                 lower        est.       upper
(Intercept) -0.3873448 -0.36936532 -0.35138579
age          0.0204230  0.02308004  0.02573708
log(ht)      2.1674832  2.24939340  2.33130360

 Random Effects:
  Level: id 
                            lower        est.        upper
sd((Intercept))       0.095315000  0.11107952  0.129451390
sd(age)               0.005828914  0.00706045  0.008552184
cor((Intercept),age) -0.685485568 -0.55220425 -0.383114275

 Within-group standard error:
     lower       est.      upper 
0.05812314 0.06025488 0.06246480 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="do">### Predictions</span></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>new_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">id =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">25</span>, <span class="dv">25</span>, <span class="dv">25</span>),</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">age =</span> <span class="fu">c</span>(<span class="dv">18</span>, <span class="dv">18</span>, <span class="dv">18</span>, <span class="dv">18</span>),</span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>                       <span class="at">ht =</span> <span class="fu">c</span>(<span class="fl">1.54</span>, <span class="fl">1.85</span>, <span class="fl">1.7</span>, <span class="dv">2</span>),</span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">baseht =</span> <span class="fu">c</span>(<span class="fl">1.2</span>, <span class="fl">1.32</span>, <span class="fl">1.32</span>, <span class="fl">1.32</span>),</span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a>                       <span class="at">baseage =</span> <span class="fu">c</span>(<span class="fl">9.3415</span>, <span class="fl">8.0274</span>, <span class="fl">8.0274</span>, <span class="fl">8.0274</span>),</span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a>                       <span class="at">loght=</span><span class="fu">log</span>(<span class="fu">c</span>(<span class="fl">1.54</span>, <span class="fl">1.85</span>, <span class="fl">1.7</span>, <span class="dv">2</span>)))</span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a><span class="co"># level specifies whether at the population [0] or subject [1] level</span></span>
<span id="cb99-10"><a href="#cb99-10" aria-hidden="true" tabindex="-1"></a><span class="fu">predict</span>(model, <span class="at">newdata =</span> new_data, <span class="at">level =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  id predict.fixed predict.id
1  1      1.017324  0.9922821
2 25      1.429870  1.3972195
3 25      1.239667  1.2070167
4 25      1.605236  1.5725857</code></pre>
</div>
</div>
</section>
<section id="results-summary" class="level3" data-number="1.4.7">
<h3 data-number="1.4.7" class="anchored" data-anchor-id="results-summary"><span class="header-section-number">1.4.7</span> Results summary:</h3>
<ul>
<li>Age explains a significant amount of the variability of lung size - a one year increase in age is roughly equivalent to a <code>exp(0.023)</code> in lung size (fev1)</li>
<li>Height also explains lung size, we see that for every 10 cm, we have that lungs are <code>exp(2.25*log(0.1))</code> (fev1) bigger</li>
<li>Population average lung size is <code>exp(-0.308090040)</code></li>
<li>There is some evidence that the time at which the subject entered the study was predictive of their lung size. Investigate!</li>
<li>Seems like lungs stop growing at 16 - may be no need to study after that age?</li>
</ul>
</section>
</section>
<section id="case-study-tale-of-two-thieves-see-cabrera2002" class="level2" data-number="1.5">
<h2 data-number="1.5" class="anchored" data-anchor-id="case-study-tale-of-two-thieves-see-cabrera2002"><span class="header-section-number">1.5</span> Case study: Tale of two thieves, see <span class="citation" data-cites="Cabrera2002">Cabrera and McDougall (<a href="references.html#ref-Cabrera2002" role="doc-biblioref">2002</a>)</span></h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(nlme)</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4)</span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'ggplot2' was built under R version 4.2.3</code></pre>
</div>
</div>
<section id="case-information-2" class="level3" data-number="1.5.1">
<h3 data-number="1.5.1" class="anchored" data-anchor-id="case-information-2"><span class="header-section-number">1.5.1</span> Case information:</h3>
<ul>
<li>Concentration Data – Data on concentration of active ingredient in tablets and samples from blender</li>
<li>Recall: “Our main concern is that the amount of active ingredient is consistent in the X tablets. We would like you to analyse both samples to determine how much the active ingredient differs from tablet to tablet. We also want to compare the quality of the samples retrieved by the thieves to determine Which one is better?”</li>
</ul>
<p>Suppose we receive the following documentation:</p>
<p>Prescription and over-the-counter drugs contain a mixture of both active and inactive ingredients, with the dosage determined by the amount of active ingredient in each tablet. Making sure the tablets contain the correct dosage is an important problem in the drug manufacturing industry and in this case study, we consider an experiment conducted by a pharmaceutical company to investigate sampling variability and bias associated with the manufacture of a certain type of tablet.</p>
</section>
<section id="outline-of-the-problem" class="level3" data-number="1.5.2">
<h3 data-number="1.5.2" class="anchored" data-anchor-id="outline-of-the-problem"><span class="header-section-number">1.5.2</span> Outline of the Problem</h3>
<p>Tablet Manufacture The tablets were manufactured by mixing the active and inactive ingredients in a “V-blender,” so-named because it looks like a large V. (See Figure 8.1.) Mixing was achieved by rotating the V-blender in the vertical direction. After the mixture was thoroughly blended, the powder was discharged from the bottom of the V-blender and compressed into tablet form.</p>
<p>Uniform Content: The most important requirement of this manufacturing process was that the tablets have uniform content. That is, the correct amount of active ingredient must be present in each tablet. The content uniformity of the mixture within the V-blender will need to be assessed. Thief Sampling A “thief” instrument was used to obtain samples from different locations within the V-blender. This was essentially a long pole with a closed scoop at one end, which was plunged into the powder mixture by a mechanical device. At the appropriate depth for a given location, the scoop was opened and a sample collected. Considerable force was needed to insert a thief into the powder mixture and it was of interest to compare two types of thieves.</p>
<ul>
<li><p>The Unit Dose thief collects three individual unit dose samples at each location.</p></li>
<li><p>The Intermediate Dose thief collects one large sample which is itself sampled to give three unit dose samples.</p></li>
</ul>
</section>
<section id="experiment-procedure" class="level3" data-number="1.5.3">
<h3 data-number="1.5.3" class="anchored" data-anchor-id="experiment-procedure"><span class="header-section-number">1.5.3</span> Experiment Procedure</h3>
<p>The objective of this experiment was to study bias and variability differences between the two thieves and to compare the thief-sampled results with those of the tablets. The experiment was implemented as follows.</p>
<ol type="1">
<li>Blend the mixture in the V-blender for 20 minutes.</li>
<li>Tie the thieves together and use them to obtain samples from six locations within the V-blender. A schematic of the V-blender and sampling locations was shown previously.</li>
<li>Discharge the powder from the V-blender and compress it to form tablets. Load tablets into 30 drums.</li>
<li>Select 10 drums and sample three tablets from each of these drums.</li>
<li>Assay all samples to determine the amount of active ingredient in each sample. The specified assay value is: 35 mg/100 mg.</li>
</ol>
<p>The locations shown in the blender represented the “desired” sampling positions for the thieves. In the actual experiment, these “fixed” positions were subject to a certain amount of variability. The samples collected by the thieves can be regarded as random within each location.</p>
<p>In the Tablet experiment, the order in which the drums were filled was recorded and this information was incorporated into the random selection procedure. Specifically, one drum was randomly selected from each triple sequence: {1, 2, 3} { 4, 5, 6} . . . {28, 29, 30}. The factor DRUM could therefore be used to test for a “time” effect in the Tablet data.</p>
<p>Data Columns:</p>
<ul>
<li>method</li>
<li>location</li>
<li>replicate</li>
<li>assay/yb</li>
<li>drum</li>
</ul>
<p>Data Info: see 8.1 in <span class="citation" data-cites="Cabrera2002">Cabrera and McDougall (<a href="references.html#ref-Cabrera2002" role="doc-biblioref">2002</a>)</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>thief<span class="ot">=</span><span class="fu">read.csv</span>(<span class="st">'data/thief.csv'</span>)</span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>tablet<span class="ot">=</span><span class="fu">read.csv</span>(<span class="st">'data/tablet.csv'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="eda-1" class="level3" data-number="1.5.4">
<h3 data-number="1.5.4" class="anchored" data-anchor-id="eda-1"><span class="header-section-number">1.5.4</span> EDA</h3>
<p>Let’s explore the data</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">cex.lab=</span><span class="dv">2</span>,<span class="at">cex.axis=</span><span class="dv">2</span>,<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(tablet)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  methdb drum tablet    yb
1 Tablet    1      1 35.77
2 Tablet    1      2 39.44
3 Tablet    1      3 36.43
4 Tablet    5      1 35.71
5 Tablet    5      2 37.08
6 Tablet    5      3 36.54</code></pre>
</div>
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(tablet)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    methdb               drum          tablet        yb       
 Length:30          Min.   : 1.0   Min.   :1   Min.   :33.09  
 Class :character   1st Qu.: 7.0   1st Qu.:1   1st Qu.:35.10  
 Mode  :character   Median :15.5   Median :2   Median :35.69  
                    Mean   :14.9   Mean   :2   Mean   :35.79  
                    3rd Qu.:22.0   3rd Qu.:3   3rd Qu.:36.52  
                    Max.   :28.0   Max.   :3   Max.   :39.44  </code></pre>
</div>
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(thief)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  METHOD LOCATION REPLICATE ASSAY
1   Intm        1         1 34.38
2   Intm        1         2 34.87
3   Intm        1         3 35.71
4   Intm        2         1 35.31
5   Intm        2         2 37.59
6   Intm        2         3 38.02</code></pre>
</div>
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(thief)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    METHOD             LOCATION     REPLICATE     ASSAY      
 Length:36          Min.   :1.0   Min.   :1   Min.   :32.77  
 Class :character   1st Qu.:2.0   1st Qu.:1   1st Qu.:35.39  
 Mode  :character   Median :3.5   Median :2   Median :36.67  
                    Mean   :3.5   Mean   :2   Mean   :36.65  
                    3rd Qu.:5.0   3rd Qu.:3   3rd Qu.:37.88  
                    Max.   :6.0   Max.   :3   Max.   :39.80  </code></pre>
</div>
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Check for missing values</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a><span class="fu">colSums</span>(<span class="fu">is.na</span>(thief))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   METHOD  LOCATION REPLICATE     ASSAY 
        0         0         0         0 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="fu">colSums</span>(<span class="fu">is.na</span>(tablet))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>methdb   drum tablet     yb 
     0      0      0      0 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="fu">unique</span>(tablet<span class="sc">$</span>methdb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Tablet"</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>tablet<span class="sc">$</span>drum<span class="ot">=</span><span class="fu">as.factor</span>(tablet<span class="sc">$</span>drum); tablet<span class="sc">$</span>drum</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 1  1  1  5  5  5  7  7  7  11 11 11 14 14 14 17 17 17 19 19 19 22 22 22 25
[26] 25 25 28 28 28
Levels: 1 5 7 11 14 17 19 22 25 28</code></pre>
</div>
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>e <span class="ot">&lt;-</span> ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(tablet, ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> drum, <span class="at">y=</span>yb)) <span class="sc">+</span> ggplot2<span class="sc">::</span><span class="fu">geom_boxplot</span>()</span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>e</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/EDA 3-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>e <span class="ot">&lt;-</span> ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(tablet, ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> drum, <span class="at">y=</span>yb)) <span class="sc">+</span> ggplot2<span class="sc">::</span><span class="fu">geom_point</span>()</span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>e</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/EDA 3-2.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(ASSAY <span class="sc">~</span> LOCATION, <span class="at">col=</span><span class="fu">as.numeric</span>(thief<span class="sc">$</span>METHOD),<span class="at">data=</span>thief)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in boxplot.default(split(mf[[response]], mf[-response], drop = drop, :
NAs introduced by coercion</code></pre>
</div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/EDA 3-3.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(ASSAY <span class="sc">~</span> METHOD,<span class="at">data=</span>thief)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/EDA 3-4.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>color<span class="ot">=</span><span class="fu">as.integer</span>(<span class="fu">as.factor</span>(thief<span class="sc">$</span>METHOD))<span class="sc">+</span><span class="dv">1</span></span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(thief<span class="sc">$</span>LOCATION ,thief<span class="sc">$</span>ASSAY,<span class="at">col=</span>color,<span class="at">pch=</span><span class="dv">22</span>,<span class="at">bg=</span>color)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/EDA 3-5.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>What can we conclude from this exploratory analysis?</p>
</section>
<section id="specification" class="level3" data-number="1.5.5">
<h3 data-number="1.5.5" class="anchored" data-anchor-id="specification"><span class="header-section-number">1.5.5</span> Specification</h3>
<p>Let’s tackle the first question: how much does the active ingredient in the tablets vary? Write down the model fit below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(tablet)[<span class="dv">4</span>]<span class="ot">=</span><span class="st">"con"</span></span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a>model<span class="ot">=</span><span class="fu">lme</span>(</span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">fixed=</span> con <span class="sc">~</span><span class="dv">1</span>,</span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">random=</span> con <span class="sc">~</span> <span class="dv">1</span> <span class="sc">|</span> drum, <span class="at">data=</span>tablet )</span>
<span id="cb126-5"><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed-effects model fit by REML
  Data: tablet 
      AIC      BIC  logLik
  108.092 112.1939 -51.046

Random effects:
 Formula: con ~ 1 | drum
        (Intercept) Residual
StdDev:   0.6673375 1.197821

Fixed effects:  con ~ 1 
             Value Std.Error DF  t-value p-value
(Intercept) 35.789 0.3039075 20 117.7628       0

Standardized Within-Group Residuals:
        Min          Q1         Med          Q3         Max 
-1.58945875 -0.62071916 -0.08544433  0.37232202  2.47467411 

Number of Observations: 30
Number of Groups: 10 </code></pre>
</div>
</div>
<p>Okay, the “between drum standard deviation” is half the residual standard deviation. Let’s test if its non-zero. Recall that for REML estimates, the asymptotic distribution for the LRT is not the same as usual. In this case, under the null hypothesis, <span class="math inline">\(Y_{ij}\sim N(\mu,\sigma^2)\)</span>. Thus,</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>fit_null<span class="ot">&lt;-</span><span class="fu">lm</span>(con <span class="sc">~</span> <span class="dv">1</span> , <span class="at">data=</span>tablet)</span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>observed<span class="ot">=</span>lmtest<span class="sc">::</span><span class="fu">lrtest</span>(fit_null,model)<span class="sc">$</span>Chisq[<span class="dv">2</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in modelUpdate(objects[[i - 1]], objects[[i]]): original model was of
class "lm", updated model is of class "lme"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>fe<span class="ot">=</span>nlme<span class="sc">::</span><span class="fu">fixed.effects</span>(model); fe</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept) 
     35.789 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>sigma_drum_est<span class="ot">=</span> nlme<span class="sc">::</span><span class="fu">getVarCov</span>(model); sigma_drum_est</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Random effects variance covariance matrix
            (Intercept)
(Intercept)     0.44534
  Standard Deviations: 0.66734 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a>sigma_est<span class="ot">=</span>model<span class="sc">$</span>sigma; sigma_est</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.197821</code></pre>
</div>
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>n<span class="ot">=</span><span class="fu">nrow</span>(tablet)</span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a>n_sim<span class="ot">=</span><span class="dv">100</span></span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a>simulated<span class="ot">=</span><span class="fu">replicate</span>(n,<span class="fu">rnorm</span>(n_sim,fe[<span class="dv">1</span>],sigma_est))</span>
<span id="cb136-5"><a href="#cb136-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-6"><a href="#cb136-6" aria-hidden="true" tabindex="-1"></a><span class="co"># n_sim x n</span></span>
<span id="cb136-7"><a href="#cb136-7" aria-hidden="true" tabindex="-1"></a><span class="co"># dim(simulated)</span></span>
<span id="cb136-8"><a href="#cb136-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-9"><a href="#cb136-9" aria-hidden="true" tabindex="-1"></a>compute_lrt<span class="ot">=</span><span class="cf">function</span>(y){</span>
<span id="cb136-10"><a href="#cb136-10" aria-hidden="true" tabindex="-1"></a>  tablet_copy<span class="ot">=</span>tablet</span>
<span id="cb136-11"><a href="#cb136-11" aria-hidden="true" tabindex="-1"></a>  tablet_copy<span class="sc">$</span>con<span class="ot">=</span>y</span>
<span id="cb136-12"><a href="#cb136-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb136-13"><a href="#cb136-13" aria-hidden="true" tabindex="-1"></a>  alt<span class="ot">=</span><span class="fu">lme</span>(</span>
<span id="cb136-14"><a href="#cb136-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">fixed=</span> con<span class="sc">~</span><span class="dv">1</span>,</span>
<span id="cb136-15"><a href="#cb136-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">random=</span> con <span class="sc">~</span> <span class="dv">1</span> <span class="sc">|</span> drum, <span class="at">data=</span>tablet_copy )</span>
<span id="cb136-16"><a href="#cb136-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb136-17"><a href="#cb136-17" aria-hidden="true" tabindex="-1"></a>  null<span class="ot">&lt;-</span><span class="fu">lm</span>(con <span class="sc">~</span> <span class="dv">1</span> , <span class="at">data=</span>tablet_copy)</span>
<span id="cb136-18"><a href="#cb136-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb136-19"><a href="#cb136-19" aria-hidden="true" tabindex="-1"></a>  test<span class="ot">=</span>lmtest<span class="sc">::</span><span class="fu">lrtest</span>(null,alt)<span class="sc">$</span>Chisq[<span class="dv">2</span>]</span>
<span id="cb136-20"><a href="#cb136-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(test)</span>
<span id="cb136-21"><a href="#cb136-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb136-22"><a href="#cb136-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-23"><a href="#cb136-23" aria-hidden="true" tabindex="-1"></a>ts<span class="ot">=</span><span class="fu">suppressWarnings</span>(<span class="fu">apply</span>(simulated, <span class="dv">1</span>, compute_lrt))</span>
<span id="cb136-24"><a href="#cb136-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-25"><a href="#cb136-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-26"><a href="#cb136-26" aria-hidden="true" tabindex="-1"></a><span class="co"># ts</span></span>
<span id="cb136-27"><a href="#cb136-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-28"><a href="#cb136-28" aria-hidden="true" tabindex="-1"></a>pvalue<span class="ot">=</span><span class="fu">mean</span>(observed<span class="sc">&lt;=</span>ts); pvalue</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.87</code></pre>
</div>
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(ts)</span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v=</span>observed); observed</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/Testing 3-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.4731465</code></pre>
</div>
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span><span class="sc">-</span><span class="fu">pchisq</span>(observed,<span class="dv">1</span>)<span class="sc">/</span><span class="dv">2</span><span class="sc">-</span>(observed<span class="sc">&gt;</span><span class="dv">0</span>)<span class="sc">/</span><span class="dv">2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.2457716</code></pre>
</div>
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a>lmtest<span class="sc">::</span><span class="fu">lrtest</span>(fit_null,model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in modelUpdate(objects[[i - 1]], objects[[i]]): original model was of
class "lm", updated model is of class "lme"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Likelihood ratio test

Model 1: con ~ 1
Model 2: con ~ 1
  #Df  LogLik Df  Chisq Pr(&gt;Chisq)
1   2 -51.283                     
2   3 -51.046  1 0.4731     0.4915</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(tablet<span class="sc">$</span>con)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="diagnostics-1" class="level3" data-number="1.5.6">
<h3 data-number="1.5.6" class="anchored" data-anchor-id="diagnostics-1"><span class="header-section-number">1.5.6</span> Diagnostics</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/GOF 2-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a><span class="fu">qqnorm</span>(model, <span class="sc">~</span> <span class="fu">residuals</span>(.,<span class="at">type=</span><span class="st">"pearson"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/GOF 2-2.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">ranef</span>(model))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/GOF 2-3.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb149"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="fu">qqnorm</span>(model, <span class="sc">~</span> <span class="fu">ranef</span>(.))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/GOF 2-4.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model, con <span class="sc">~</span> <span class="fu">fitted</span>(.),<span class="at">abline=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/GOF 2-5.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb151"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a>fit_null<span class="ot">&lt;-</span><span class="fu">lm</span>(con <span class="sc">~</span> <span class="dv">1</span> , <span class="at">data=</span>tablet)</span>
<span id="cb151-2"><a href="#cb151-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-3"><a href="#cb151-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-4"><a href="#cb151-4" aria-hidden="true" tabindex="-1"></a><span class="fu">confint</span>(fit_null)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               2.5 %   97.5 %
(Intercept) 35.28119 36.29681</code></pre>
</div>
</div>
<p>Let’s tackle the next question: which sampling method is better? – which sampling method has a lower variability?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb153"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb153-2"><a href="#cb153-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">cex.lab=</span><span class="dv">2</span>,<span class="at">cex.axis=</span><span class="dv">2</span>,<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb153-3"><a href="#cb153-3" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(ASSAY<span class="sc">~</span>METHOD,<span class="at">data=</span>thief)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/EDA 2-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb154"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a>thief<span class="sc">$</span>LOCATION<span class="ot">=</span><span class="fu">as.factor</span>(thief<span class="sc">$</span>LOCATION)</span>
<span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a>e <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(thief, <span class="fu">aes</span>(<span class="at">x =</span> LOCATION, <span class="at">y=</span>ASSAY,<span class="at">fill=</span>METHOD)) <span class="sc">+</span> <span class="fu">geom_boxplot</span>()</span>
<span id="cb154-3"><a href="#cb154-3" aria-hidden="true" tabindex="-1"></a>e</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/EDA 2-2.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb155"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a>thief<span class="sc">$</span>LOCATION<span class="ot">=</span><span class="fu">as.factor</span>(thief<span class="sc">$</span>LOCATION)</span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a>thief<span class="sc">$</span>METHOD<span class="ot">=</span><span class="fu">as.factor</span>(thief<span class="sc">$</span>METHOD)</span>
<span id="cb155-3"><a href="#cb155-3" aria-hidden="true" tabindex="-1"></a>e <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(thief, <span class="fu">aes</span>(<span class="at">x =</span> LOCATION, <span class="at">y=</span>ASSAY, <span class="at">color=</span>METHOD)) <span class="sc">+</span> <span class="fu">geom_point</span>()</span>
<span id="cb155-4"><a href="#cb155-4" aria-hidden="true" tabindex="-1"></a>e</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/EDA 2-3.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="co"># boxplot(ASSAY ~ LOCATION, col=as.numeric(thief$METHOD),data=thief)</span></span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a>thief_wide<span class="ot">=</span><span class="fu">reshape</span>(thief[,<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>],<span class="at">timevar=</span><span class="st">'REPLICATE'</span>, <span class="at">idvar=</span><span class="fu">c</span>(<span class="st">'LOCATION'</span>,<span class="st">'METHOD'</span>),  <span class="at">direction =</span> <span class="st">"wide"</span>,<span class="at">v.names=</span><span class="st">'ASSAY'</span>)</span>
<span id="cb156-3"><a href="#cb156-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(thief_wide)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   METHOD LOCATION ASSAY.1 ASSAY.2 ASSAY.3
1    Intm        1   34.38   34.87   35.71
4    Intm        2   35.31   37.59   38.02
7    Intm        3   36.71   36.56   35.92
10   Intm        4   37.80   37.41   38.00
13   Intm        5   36.28   36.63   36.62
16   Intm        6   38.89   39.80   37.84</code></pre>
</div>
<div class="sourceCode cell-code" id="cb158"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a>corrplot<span class="sc">::</span><span class="fu">corrplot</span>(<span class="fu">cor</span>(thief_wide[,<span class="dv">3</span><span class="sc">:</span><span class="dv">5</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/EDA 2-4.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb159"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a>corrplot<span class="sc">::</span><span class="fu">corrplot</span>(<span class="fu">cor</span>(thief_wide[<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>,<span class="dv">3</span><span class="sc">:</span><span class="dv">5</span>]),<span class="at">main=</span><span class="st">"Intm"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/EDA 2-5.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb160"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a>corrplot<span class="sc">::</span><span class="fu">corrplot</span>(<span class="fu">cor</span>(thief_wide[<span class="dv">7</span><span class="sc">:</span><span class="dv">12</span>,<span class="dv">3</span><span class="sc">:</span><span class="dv">5</span>]),<span class="at">main=</span><span class="st">"Unit"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/EDA 2-6.png" class="img-fluid" width="672"></p>
</div>
</div>
<ul>
<li>We have 6 observations per location, three for each sampling type</li>
<li>Each location could have its own mean concentration – see EDA <span class="math inline">\(\mu+\beta_i\)</span></li>
<li>We expect that the assays within each sampling type will vary around their location means - <span class="math inline">\(\beta_i\)</span></li>
<li>Nested within the locations is the replicates , 3 per sampling method</li>
<li>We can capture the variability of sampling at each location via the random effect location.</li>
<li>Let <span class="math inline">\(i\)</span> be the location number, <span class="math inline">\(j\)</span> be the sampling type and <span class="math inline">\(k\)</span> be the replicate number</li>
</ul>
<p><span class="math display">\[Y_{ijk}=\mu+\beta_i+\alpha_j+\epsilon_{ijk}.\]</span></p>
<p>We can also write this as follows:</p>
<ul>
<li>Let <span class="math inline">\(i\)</span> be the location number and <span class="math inline">\(j\)</span> be the sampling type</li>
<li>Let <span class="math inline">\(W_{ij}=(1,j-1)\)</span></li>
<li>Let <span class="math inline">\(Z_{ij}=1\)</span> with <span class="math inline">\(\beta_i\sim N(0, \Sigma_\beta)\)</span>.</li>
</ul>
<p><span class="math display">\[Y_{ij}=W_{ij}\alpha+Z_{ij}\beta_{i}+\epsilon_{ij}.\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb161"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a>thief<span class="ot">=</span>thief[,<span class="sc">-</span><span class="dv">5</span>]</span>
<span id="cb161-2"><a href="#cb161-2" aria-hidden="true" tabindex="-1"></a>thief<span class="sc">$</span>REPLICATE<span class="ot">=</span><span class="fu">as.factor</span>(thief<span class="sc">$</span>REPLICATE)</span>
<span id="cb161-3"><a href="#cb161-3" aria-hidden="true" tabindex="-1"></a>thief<span class="sc">$</span>LOCATION<span class="ot">=</span><span class="fu">as.factor</span>(thief<span class="sc">$</span>LOCATION)</span>
<span id="cb161-4"><a href="#cb161-4" aria-hidden="true" tabindex="-1"></a>thief<span class="sc">$</span>METHOD<span class="ot">=</span><span class="fu">as.factor</span>(thief<span class="sc">$</span>METHOD)</span>
<span id="cb161-5"><a href="#cb161-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(thief<span class="sc">$</span>METHOD)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] Intm Intm Intm Intm Intm Intm Intm Intm Intm Intm Intm Intm Intm Intm Intm
[16] Intm Intm Intm Unit Unit Unit Unit Unit Unit Unit Unit Unit Unit Unit Unit
[31] Unit Unit Unit Unit Unit Unit
Levels: Intm Unit</code></pre>
</div>
<div class="sourceCode cell-code" id="cb163"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Unit is True</span></span>
<span id="cb163-2"><a href="#cb163-2" aria-hidden="true" tabindex="-1"></a>thief<span class="sc">$</span>ASSAY<span class="ot">=</span><span class="fu">as.numeric</span>(thief<span class="sc">$</span>ASSAY)</span>
<span id="cb163-3"><a href="#cb163-3" aria-hidden="true" tabindex="-1"></a>thief</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   METHOD LOCATION REPLICATE ASSAY
1    Intm        1         1 34.38
2    Intm        1         2 34.87
3    Intm        1         3 35.71
4    Intm        2         1 35.31
5    Intm        2         2 37.59
6    Intm        2         3 38.02
7    Intm        3         1 36.71
8    Intm        3         2 36.56
9    Intm        3         3 35.92
10   Intm        4         1 37.80
11   Intm        4         2 37.41
12   Intm        4         3 38.00
13   Intm        5         1 36.28
14   Intm        5         2 36.63
15   Intm        5         3 36.62
16   Intm        6         1 38.89
17   Intm        6         2 39.80
18   Intm        6         3 37.84
19   Unit        1         1 33.94
20   Unit        1         2 34.72
21   Unit        1         3 34.10
22   Unit        2         1 39.11
23   Unit        2         2 37.51
24   Unit        2         3 37.79
25   Unit        3         1 37.46
26   Unit        3         2 34.12
27   Unit        3         3 35.94
28   Unit        4         1 38.05
29   Unit        4         2 34.82
30   Unit        4         3 35.42
31   Unit        5         1 36.52
32   Unit        5         2 38.60
33   Unit        5         3 38.16
34   Unit        6         1 39.16
35   Unit        6         2 32.77
36   Unit        6         3 36.95</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb165"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a>model<span class="ot">=</span><span class="fu">lme</span>(</span>
<span id="cb165-2"><a href="#cb165-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">fixed=</span> ASSAY <span class="sc">~</span> METHOD ,</span>
<span id="cb165-3"><a href="#cb165-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">random=</span>  <span class="sc">~</span> <span class="dv">1</span><span class="sc">|</span>LOCATION, <span class="at">data=</span>thief)</span>
<span id="cb165-4"><a href="#cb165-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed-effects model fit by REML
  Data: thief 
       AIC      BIC   logLik
  142.2532 148.3586 -67.1266

Random effects:
 Formula: ~1 | LOCATION
        (Intercept) Residual
StdDev:   0.9596085 1.456579

Fixed effects:  ASSAY ~ METHOD 
               Value Std.Error DF  t-value p-value
(Intercept) 36.90778 0.5209056 29 70.85310  0.0000
METHODUnit  -0.51111 0.4855263 29 -1.05269  0.3012
 Correlation: 
           (Intr)
METHODUnit -0.466

Standardized Within-Group Residuals:
        Min          Q1         Med          Q3         Max 
-2.94429462 -0.46995636  0.02331003  0.53623214  1.53118448 

Number of Observations: 36
Number of Groups: 6 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb167"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">ranef</span>(model))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  (Intercept)
1  -1.4683710
2   0.6522971
3  -0.3857585
4   0.1910729
5   0.3488284
6   0.6619311</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb169"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Step 1. Computing T-hat</span></span>
<span id="cb169-2"><a href="#cb169-2" aria-hidden="true" tabindex="-1"></a>fit_null<span class="ot">&lt;-</span><span class="fu">lm</span>(ASSAY <span class="sc">~</span> <span class="dv">1</span> , <span class="at">data=</span>thief)</span>
<span id="cb169-3"><a href="#cb169-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-4"><a href="#cb169-4" aria-hidden="true" tabindex="-1"></a>observed<span class="ot">=</span>lmtest<span class="sc">::</span><span class="fu">lrtest</span>(fit_null,model)<span class="sc">$</span>Chisq[<span class="dv">2</span>]; observed</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in modelUpdate(objects[[i - 1]], objects[[i]]): original model was of
class "lm", updated model is of class "lme"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 5.442094</code></pre>
</div>
<div class="sourceCode cell-code" id="cb172"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Step 2. </span></span>
<span id="cb172-2"><a href="#cb172-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-3"><a href="#cb172-3" aria-hidden="true" tabindex="-1"></a><span class="co">#Get the fixed effects</span></span>
<span id="cb172-4"><a href="#cb172-4" aria-hidden="true" tabindex="-1"></a>fe<span class="ot">=</span>nlme<span class="sc">::</span><span class="fu">fixed.effects</span>(model); fe</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept)  METHODUnit 
 36.9077778  -0.5111111 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb174"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Get the estimated variance of the RE</span></span>
<span id="cb174-2"><a href="#cb174-2" aria-hidden="true" tabindex="-1"></a>sigma_b_est<span class="ot">=</span> nlme<span class="sc">::</span><span class="fu">getVarCov</span>(model); sigma_b_est</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Random effects variance covariance matrix
            (Intercept)
(Intercept)     0.92085
  Standard Deviations: 0.95961 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb176"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Get the estimate of sigma</span></span>
<span id="cb176-2"><a href="#cb176-2" aria-hidden="true" tabindex="-1"></a>sigma_est<span class="ot">=</span>model<span class="sc">$</span>sigma; sigma_est</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.456579</code></pre>
</div>
<div class="sourceCode cell-code" id="cb178"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb178-1"><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a>n<span class="ot">=</span><span class="fu">nrow</span>(thief)</span>
<span id="cb178-2"><a href="#cb178-2" aria-hidden="true" tabindex="-1"></a>n_sim<span class="ot">=</span><span class="dv">100</span></span>
<span id="cb178-3"><a href="#cb178-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-4"><a href="#cb178-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-5"><a href="#cb178-5" aria-hidden="true" tabindex="-1"></a><span class="co">#Step 2 </span></span>
<span id="cb178-6"><a href="#cb178-6" aria-hidden="true" tabindex="-1"></a>simulated<span class="ot">=</span><span class="fu">t</span>(<span class="fu">replicate</span>(n_sim,<span class="fu">rnorm</span>(n,fe[<span class="dv">1</span>],sigma_est))); <span class="fu">dim</span>(simulated)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 100  36</code></pre>
</div>
<div class="sourceCode cell-code" id="cb180"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Step 3</span></span>
<span id="cb180-2"><a href="#cb180-2" aria-hidden="true" tabindex="-1"></a><span class="co">#takes a simulated sample y and computes the LRT for Y</span></span>
<span id="cb180-3"><a href="#cb180-3" aria-hidden="true" tabindex="-1"></a>compute_lrt<span class="ot">=</span><span class="cf">function</span>(y){</span>
<span id="cb180-4"><a href="#cb180-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb180-5"><a href="#cb180-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">#create a copy of the dataset</span></span>
<span id="cb180-6"><a href="#cb180-6" aria-hidden="true" tabindex="-1"></a>  t_copy<span class="ot">=</span>thief</span>
<span id="cb180-7"><a href="#cb180-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb180-8"><a href="#cb180-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">#replace response with new sample</span></span>
<span id="cb180-9"><a href="#cb180-9" aria-hidden="true" tabindex="-1"></a>  t_copy<span class="sc">$</span>ASSAY<span class="ot">=</span>y</span>
<span id="cb180-10"><a href="#cb180-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb180-11"><a href="#cb180-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">#replace response with new sampl</span></span>
<span id="cb180-12"><a href="#cb180-12" aria-hidden="true" tabindex="-1"></a>  alt<span class="ot">=</span><span class="fu">lme</span>(</span>
<span id="cb180-13"><a href="#cb180-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">fixed=</span> ASSAY<span class="sc">~</span><span class="dv">1</span>,</span>
<span id="cb180-14"><a href="#cb180-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">random=</span>ASSAY <span class="sc">~</span> <span class="dv">1</span> <span class="sc">|</span> LOCATION, <span class="at">data=</span>t_copy )</span>
<span id="cb180-15"><a href="#cb180-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb180-16"><a href="#cb180-16" aria-hidden="true" tabindex="-1"></a>  null<span class="ot">&lt;-</span><span class="fu">lm</span>(ASSAY <span class="sc">~</span> <span class="dv">1</span> , <span class="at">data=</span>t_copy)</span>
<span id="cb180-17"><a href="#cb180-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb180-18"><a href="#cb180-18" aria-hidden="true" tabindex="-1"></a>  test<span class="ot">=</span>lmtest<span class="sc">::</span><span class="fu">lrtest</span>(null,alt)<span class="sc">$</span>Chisq[<span class="dv">2</span>]</span>
<span id="cb180-19"><a href="#cb180-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb180-20"><a href="#cb180-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb180-21"><a href="#cb180-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(test)</span>
<span id="cb180-22"><a href="#cb180-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb180-23"><a href="#cb180-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-24"><a href="#cb180-24" aria-hidden="true" tabindex="-1"></a><span class="co">#compute LRT for each simulated sample </span></span>
<span id="cb180-25"><a href="#cb180-25" aria-hidden="true" tabindex="-1"></a>ts<span class="ot">=</span><span class="fu">suppressWarnings</span>(<span class="fu">apply</span>(simulated, <span class="dv">1</span>, compute_lrt))</span>
<span id="cb180-26"><a href="#cb180-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-27"><a href="#cb180-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-28"><a href="#cb180-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-29"><a href="#cb180-29" aria-hidden="true" tabindex="-1"></a>pvalue<span class="ot">=</span><span class="fu">mean</span>(observed<span class="sc">&lt;=</span>ts); pvalue</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb182"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(ts,<span class="at">xlim=</span><span class="fu">c</span>(<span class="fu">min</span>(ts),<span class="dv">9</span>))</span>
<span id="cb182-2"><a href="#cb182-2" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v=</span>observed)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/Testing 2 Thieves-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb183"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb183-1"><a href="#cb183-1" aria-hidden="true" tabindex="-1"></a>observed</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 5.442094</code></pre>
</div>
</div>
<p>So then, the location effect introduces significant variability. We should recommend that they continue to sample multiple locations. The unit dose thief seems to estimate lower values of concentration, though this is erased by the standard error. Now, in general, we can see that this method is more variable, and potentially tends to underestimate the active ingredient. This fact leads me to recommend the intermediate sampling method.</p>
<ul>
<li>Are the assay values generally well behaved?</li>
<li>Is there any evidence of a location effect</li>
<li>Are the thief-sampled values comparable to the tablet values?</li>
<li>Do the tablet data show any drum or time effect?</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb185"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb185-1"><a href="#cb185-1" aria-hidden="true" tabindex="-1"></a>model<span class="ot">=</span><span class="fu">lme</span>(</span>
<span id="cb185-2"><a href="#cb185-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">fixed=</span> ASSAY<span class="sc">~</span><span class="dv">1</span>,</span>
<span id="cb185-3"><a href="#cb185-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">random=</span> ASSAY <span class="sc">~</span> <span class="dv">1</span> <span class="sc">|</span> LOCATION , <span class="at">data=</span>thief)</span>
<span id="cb185-4"><a href="#cb185-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb185-5"><a href="#cb185-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb185-6"><a href="#cb185-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/GOF 3-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb186"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a><span class="fu">qqnorm</span>(model, <span class="sc">~</span> <span class="fu">residuals</span>(.,<span class="at">type=</span><span class="st">"pearson"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/GOF 3-2.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb187"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb187-1"><a href="#cb187-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">ranef</span>(model))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/GOF 3-3.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb188"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a><span class="fu">qqnorm</span>(<span class="fu">ranef</span>(model)[,<span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/GOF 3-4.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb189"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb189-1"><a href="#cb189-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model, ASSAY <span class="sc">~</span> <span class="fu">fitted</span>(.),<span class="at">abline=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/GOF 3-5.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb190"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fit_null&lt;-lm(ASSAY ~ 1 , data=thief)</span></span>
<span id="cb190-2"><a href="#cb190-2" aria-hidden="true" tabindex="-1"></a><span class="co"># confint(fit_null)</span></span>
<span id="cb190-3"><a href="#cb190-3" aria-hidden="true" tabindex="-1"></a><span class="co"># fit_null</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can also fit a random effect for each of the methods and locations:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb191"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a>model<span class="ot">=</span><span class="fu">lme</span>(</span>
<span id="cb191-2"><a href="#cb191-2" aria-hidden="true" tabindex="-1"></a>     <span class="at">fixed=</span> ASSAY<span class="sc">~</span>METHOD,</span>
<span id="cb191-3"><a href="#cb191-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">random=</span> ASSAY <span class="sc">~</span> METHOD <span class="sc">|</span> LOCATION , <span class="at">data=</span>thief)</span>
<span id="cb191-4"><a href="#cb191-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed-effects model fit by REML
  Data: thief 
       AIC      BIC    logLik
  145.3404 154.4986 -66.67022

Random effects:
 Formula: ASSAY ~ METHOD | LOCATION
 Structure: General positive-definite, Log-Cholesky parametrization
            StdDev   Corr  
(Intercept) 1.045122 (Intr)
METHODUnit  1.021304 -0.363
Residual    1.360833       

Fixed effects:  ASSAY ~ METHOD 
               Value Std.Error DF  t-value p-value
(Intercept) 36.90778 0.5337867 29 69.14331  0.0000
METHODUnit  -0.51111 0.6161222 29 -0.82956  0.4136
 Correlation: 
           (Intr)
METHODUnit -0.509

Standardized Within-Group Residuals:
       Min         Q1        Med         Q3        Max 
-2.8314642 -0.4546280  0.0113704  0.5126063  1.8641882 

Number of Observations: 36
Number of Groups: 6 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb193"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb193-1"><a href="#cb193-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We can see that the variability coming from each source is somewhat large. </span></span>
<span id="cb193-2"><a href="#cb193-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-3"><a href="#cb193-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-4"><a href="#cb193-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-5"><a href="#cb193-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">ranef</span>(model))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/Alt 3-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb194"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb194-1"><a href="#cb194-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/Alt 3-2.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb195"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb195-1"><a href="#cb195-1" aria-hidden="true" tabindex="-1"></a><span class="fu">qqnorm</span>(model, <span class="sc">~</span><span class="fu">residuals</span>(., <span class="at">type =</span> <span class="st">"normalized"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/Alt 3-3.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb196"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb196-1"><a href="#cb196-1" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(<span class="fu">residuals</span>(model, <span class="at">type =</span> <span class="st">"normalized"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/Alt 3-4.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb197"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb197-1"><a href="#cb197-1" aria-hidden="true" tabindex="-1"></a>large<span class="ot">=</span><span class="fu">which.max</span>(<span class="fu">abs</span>(<span class="fu">residuals</span>(model, <span class="at">type =</span> <span class="st">"normalized"</span>))); large</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> 6 
35 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb199"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb199-1"><a href="#cb199-1" aria-hidden="true" tabindex="-1"></a>model<span class="ot">=</span><span class="fu">lme</span>(</span>
<span id="cb199-2"><a href="#cb199-2" aria-hidden="true" tabindex="-1"></a>     <span class="at">fixed=</span> ASSAY<span class="sc">~</span>METHOD,</span>
<span id="cb199-3"><a href="#cb199-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">random=</span> ASSAY <span class="sc">~</span> METHOD <span class="sc">|</span> LOCATION , <span class="at">data=</span>thief[<span class="sc">-</span>large,])</span>
<span id="cb199-4"><a href="#cb199-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed-effects model fit by REML
  Data: thief[-large, ] 
       AIC      BIC   logLik
  128.7654 137.7445 -58.3827

Random effects:
 Formula: ASSAY ~ METHOD | LOCATION
 Structure: General positive-definite, Log-Cholesky parametrization
            StdDev    Corr  
(Intercept) 1.1562644 (Intr)
METHODUnit  0.7965863 0.066 
Residual    1.0572951       

Fixed effects:  ASSAY ~ METHOD 
               Value Std.Error DF  t-value p-value
(Intercept) 36.90778 0.5337871 28 69.14326  0.0000
METHODUnit  -0.21293 0.4843533 28 -0.43961  0.6636
 Correlation: 
           (Intr)
METHODUnit -0.201

Standardized Within-Group Residuals:
       Min         Q1        Med         Q3        Max 
-1.8620371 -0.5179546  0.0419608  0.6032329  1.5075857 

Number of Observations: 35
Number of Groups: 6 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb201"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb201-1"><a href="#cb201-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">ranef</span>(model))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/Alt 2-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb202"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb202-1"><a href="#cb202-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/Alt 2-2.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb203"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb203-1"><a href="#cb203-1" aria-hidden="true" tabindex="-1"></a><span class="fu">qqnorm</span>(model, <span class="sc">~</span><span class="fu">residuals</span>(., <span class="at">type =</span> <span class="st">"normalized"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/Alt 2-3.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb204"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb204-1"><a href="#cb204-1" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(<span class="fu">residuals</span>(model, <span class="at">type =</span> <span class="st">"normalized"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/Alt 2-4.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb205"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb205-1"><a href="#cb205-1" aria-hidden="true" tabindex="-1"></a>large<span class="ot">=</span><span class="fu">which.max</span>(<span class="fu">residuals</span>(model, <span class="at">type =</span> <span class="st">"normalized"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb206"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb206-1"><a href="#cb206-1" aria-hidden="true" tabindex="-1"></a>model<span class="ot">=</span><span class="fu">lme</span>(</span>
<span id="cb206-2"><a href="#cb206-2" aria-hidden="true" tabindex="-1"></a>     <span class="at">fixed=</span> <span class="fu">sqrt</span>(ASSAY)<span class="sc">~</span>METHOD,</span>
<span id="cb206-3"><a href="#cb206-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">random=</span> <span class="fu">sqrt</span>(ASSAY) <span class="sc">~</span> METHOD <span class="sc">|</span> LOCATION , <span class="at">data=</span>thief[<span class="sc">-</span>large,])</span>
<span id="cb206-4"><a href="#cb206-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed-effects model fit by REML
  Data: thief[-large, ] 
        AIC       BIC   logLik
  -23.94854 -14.96949 17.97427

Random effects:
 Formula: ASSAY ~ METHOD | LOCATION
 Structure: General positive-definite, Log-Cholesky parametrization
            StdDev     Corr  
(Intercept) 0.08767712 (Intr)
METHODUnit  0.10625944 -0.405
Residual    0.10789056       

Fixed effects:  sqrt(ASSAY) ~ METHOD 
                Value  Std.Error DF   t-value p-value
(Intercept)  6.074146 0.04390786 28 138.33847  0.0000
METHODUnit  -0.054387 0.05677613 28  -0.95792  0.3463
 Correlation: 
           (Intr)
METHODUnit -0.511

Standardized Within-Group Residuals:
        Min          Q1         Med          Q3         Max 
-2.87783191 -0.44462638  0.03546945  0.45330842  2.06501422 

Number of Observations: 35
Number of Groups: 6 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb208"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb208-1"><a href="#cb208-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">ranef</span>(model))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/Alt-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb209"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb209-1"><a href="#cb209-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/Alt-2.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb210"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb210-1"><a href="#cb210-1" aria-hidden="true" tabindex="-1"></a><span class="fu">qqnorm</span>(model, <span class="sc">~</span><span class="fu">residuals</span>(., <span class="at">type =</span> <span class="st">"normalized"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/Alt-3.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb211"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb211-1"><a href="#cb211-1" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(<span class="fu">residuals</span>(model, <span class="at">type =</span> <span class="st">"normalized"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/Alt-4.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb212"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb212-1"><a href="#cb212-1" aria-hidden="true" tabindex="-1"></a>large<span class="ot">=</span><span class="fu">which.max</span>(<span class="fu">residuals</span>(model, <span class="at">type =</span> <span class="st">"normalized"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb213"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb213-1"><a href="#cb213-1" aria-hidden="true" tabindex="-1"></a>thief<span class="sc">$</span>CEN<span class="ot">=</span><span class="fu">abs</span>(thief<span class="sc">$</span>ASSAY<span class="sc">-</span><span class="fu">mean</span>(thief<span class="sc">$</span>ASSAY))</span>
<span id="cb213-2"><a href="#cb213-2" aria-hidden="true" tabindex="-1"></a>model<span class="ot">=</span><span class="fu">lme</span>(</span>
<span id="cb213-3"><a href="#cb213-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">fixed=</span> CEN <span class="sc">~</span> METHOD ,</span>
<span id="cb213-4"><a href="#cb213-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">random=</span>  <span class="sc">~</span> <span class="dv">1</span><span class="sc">|</span>LOCATION, <span class="at">data=</span>thief)</span>
<span id="cb213-5"><a href="#cb213-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed-effects model fit by REML
  Data: thief 
       AIC      BIC    logLik
  99.44747 105.5529 -45.72373

Random effects:
 Formula: ~1 | LOCATION
        (Intercept)  Residual
StdDev:   0.5372663 0.7715252

Fixed effects:  CEN ~ METHOD 
                Value Std.Error DF  t-value p-value
(Intercept) 1.0988889 0.2849187 29 3.856850  0.0006
METHODUnit  0.5922222 0.2571751 29 2.302798  0.0287
 Correlation: 
           (Intr)
METHODUnit -0.451

Standardized Within-Group Residuals:
        Min          Q1         Med          Q3         Max 
-2.59227946 -0.67605167 -0.04425782  0.47231782  2.05364082 

Number of Observations: 36
Number of Groups: 6 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb215"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb215-1"><a href="#cb215-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">ranef</span>(model))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  (Intercept)
1  0.47423228
2 -0.03335199
3 -0.42613374
4 -0.08117489
5 -0.54024717
6  0.60667552</code></pre>
</div>
<div class="sourceCode cell-code" id="cb217"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb217-1"><a href="#cb217-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(thief<span class="sc">$</span>CEN)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/Specification and estimation 4-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb218"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb218-1"><a href="#cb218-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Non-normal (of course... maybe use simulation)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Results summary:</p>
<ul>
<li>Tablet mean concentration was estimated to be 35.8 with CI (35.3, 36.3)</li>
<li>Active ingredient was uniform across blender and sampling types</li>
<li>Tablets in the drums on the end points seem to have a higher active ingredient</li>
<li>The blender has higher concentrations of active ingredient 36.65 with CI (36.0743, 37.23015)</li>
<li>The location has significant variance (~1 mg)</li>
<li>Sampling methods are equivalent in mean, but UNIT seems to have higher variance. Possibly produce smaller estimates of the concentration, but this is not statistically significant</li>
</ul>
</section>
</section>
<section id="case-study-treatment-of-lead-exposed-children" class="level2" data-number="1.6">
<h2 data-number="1.6" class="anchored" data-anchor-id="case-study-treatment-of-lead-exposed-children"><span class="header-section-number">1.6</span> Case study: Treatment of Lead-Exposed Children</h2>
<p><em>Does treatment</em> <span class="math inline">\(A\)</span> (chelation treatment with succimer) affect the levels of lead in the blood of lead-exposed children?</p>
<p><a href="https://pubmed.ncbi.nlm.nih.gov/9690266/">Data source</a> or <a href="https://content.sph.harvard.edu/fitzmaur/ala2e/">Data source</a></p>
<p>Description:</p>
<p>The Treatment of Lead-Exposed Children (TLC) trial was a placebo-controlled,randomized study of succimer (a chelating agent) in children with blood lead levels of 20-44 micrograms/dL. These data consist of four repeated measurements of blood lead levels obtained at baseline (or week 0), week 1, week 4, and week 6 on 100 children who were randomly assigned to chelation treatment with succimer or placebo.</p>
<p>Data Column Descriptions: - ID: Subject ID Number - Treatment: Which treatment group (P=Placebo; A=Succimenr) - W0, W1, W4, W6: Blood-lead levels in micrograms per deciliter at Weeks 0, 1, 4, and 6</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb219"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb219-1"><a href="#cb219-1" aria-hidden="true" tabindex="-1"></a><span class="do">################################################################################</span></span>
<span id="cb219-2"><a href="#cb219-2" aria-hidden="true" tabindex="-1"></a>TLC <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/TLC.csv"</span>,<span class="at">stringsAsFactors =</span> T)</span>
<span id="cb219-3"><a href="#cb219-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(TLC)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  ID Treatment   W0   W1   W4   W6
1  1         P 30.8 26.9 25.8 23.8
2  2         A 26.5 14.8 19.5 21.0
3  3         A 25.8 23.0 19.1 23.2
4  4         P 24.7 24.5 22.0 22.5
5  5         A 20.4  2.8  3.2  9.4
6  6         A 20.4  5.4  4.5 11.9</code></pre>
</div>
<div class="sourceCode cell-code" id="cb221"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb221-1"><a href="#cb221-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(TLC)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 100   6</code></pre>
</div>
<div class="sourceCode cell-code" id="cb223"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb223-1"><a href="#cb223-1" aria-hidden="true" tabindex="-1"></a>TLC<span class="sc">$</span>ID<span class="ot">=</span><span class="fu">as.factor</span>(TLC<span class="sc">$</span>ID)</span>
<span id="cb223-2"><a href="#cb223-2" aria-hidden="true" tabindex="-1"></a>TLC<span class="sc">$</span>ID<span class="ot">=</span><span class="fu">as.factor</span>(TLC<span class="sc">$</span>ID)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="modelling" class="level3" data-number="1.6.1">
<h3 data-number="1.6.1" class="anchored" data-anchor-id="modelling"><span class="header-section-number">1.6.1</span> Modelling:</h3>
<ul>
<li>Recall that the goal is to answer: “Does treatment <span class="math inline">\(A\)</span> affect the levels of lead in the blood of lead-exposed children?”</li>
<li>How are treatment group and time related to lead levels?</li>
<li>Given treatment and time, what do we expect the blood levels to be <span class="math inline">\(E(W|Treatment,Time)\)</span>?</li>
</ul>
<p>Putting this data into our notation gives:</p>
<ul>
<li><span class="math inline">\(n=100\)</span>, <span class="math inline">\(J=4\)</span>, <span class="math inline">\(K=1\)</span></li>
<li><span class="math inline">\(Y_{ij}\)</span> is the lead level of individual <span class="math inline">\(i\)</span> at time <span class="math inline">\(j\)</span></li>
<li><span class="math inline">\(X_{ij}\)</span> is treatment indicator of individual <span class="math inline">\(i\)</span> at time <span class="math inline">\(j\)</span></li>
<li><span class="math inline">\(t_j\in\{0,1,4,6\}\)</span></li>
</ul>
<p>Let’s explore this data a bit. Notice that the data is in “wide format”. To convert to a between long and wide format use <code>reshape()</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb224"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb224-1"><a href="#cb224-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(TLC)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  ID Treatment   W0   W1   W4   W6
1  1         P 30.8 26.9 25.8 23.8
2  2         A 26.5 14.8 19.5 21.0
3  3         A 25.8 23.0 19.1 23.2
4  4         P 24.7 24.5 22.0 22.5
5  5         A 20.4  2.8  3.2  9.4
6  6         A 20.4  5.4  4.5 11.9</code></pre>
</div>
<div class="sourceCode cell-code" id="cb226"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb226-1"><a href="#cb226-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert from "wide" to "long" and back again, using reshape.</span></span>
<span id="cb226-2"><a href="#cb226-2" aria-hidden="true" tabindex="-1"></a><span class="co"># If you're interested, you can also use `pivot_wider` and `pivot_longer` from the tidyverse</span></span>
<span id="cb226-3"><a href="#cb226-3" aria-hidden="true" tabindex="-1"></a><span class="co">#   (If that doesn't mean anything to you, feel free to ignore it!)</span></span>
<span id="cb226-4"><a href="#cb226-4" aria-hidden="true" tabindex="-1"></a>TLC_long <span class="ot">&lt;-</span> <span class="fu">reshape</span>(<span class="at">data =</span> TLC,</span>
<span id="cb226-5"><a href="#cb226-5" aria-hidden="true" tabindex="-1"></a>                    <span class="at">varying =</span> <span class="fu">c</span>(<span class="st">"W0"</span>, <span class="st">"W1"</span>, <span class="st">"W4"</span>, <span class="st">"W6"</span>),</span>
<span id="cb226-6"><a href="#cb226-6" aria-hidden="true" tabindex="-1"></a>                    <span class="at">timevar =</span> <span class="st">"week"</span>,</span>
<span id="cb226-7"><a href="#cb226-7" aria-hidden="true" tabindex="-1"></a>                    <span class="at">idvar =</span> <span class="st">"ID"</span>,</span>
<span id="cb226-8"><a href="#cb226-8" aria-hidden="true" tabindex="-1"></a>                    <span class="at">times =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">6</span>),</span>
<span id="cb226-9"><a href="#cb226-9" aria-hidden="true" tabindex="-1"></a>                    <span class="at">direction =</span> <span class="st">"long"</span>,</span>
<span id="cb226-10"><a href="#cb226-10" aria-hidden="true" tabindex="-1"></a>                    <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb226-11"><a href="#cb226-11" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(TLC_long)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    ID Treatment week    W
1.0  1         P    0 30.8
2.0  2         A    0 26.5
3.0  3         A    0 25.8
4.0  4         P    0 24.7
5.0  5         A    0 20.4
6.0  6         A    0 20.4</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb228"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb228-1"><a href="#cb228-1" aria-hidden="true" tabindex="-1"></a>TLC_wide <span class="ot">&lt;-</span> <span class="fu">reshape</span>(<span class="at">data =</span> TLC_long,</span>
<span id="cb228-2"><a href="#cb228-2" aria-hidden="true" tabindex="-1"></a>                    <span class="at">timevar =</span> <span class="st">"week"</span>,</span>
<span id="cb228-3"><a href="#cb228-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">v.names =</span> <span class="st">"W"</span>,</span>
<span id="cb228-4"><a href="#cb228-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">idvar =</span> <span class="st">"ID"</span>,</span>
<span id="cb228-5"><a href="#cb228-5" aria-hidden="true" tabindex="-1"></a>                    <span class="at">times =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">6</span>),</span>
<span id="cb228-6"><a href="#cb228-6" aria-hidden="true" tabindex="-1"></a>                    <span class="at">direction =</span> <span class="st">"wide"</span>,</span>
<span id="cb228-7"><a href="#cb228-7" aria-hidden="true" tabindex="-1"></a>                    <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb228-8"><a href="#cb228-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb228-9"><a href="#cb228-9" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(TLC_wide)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    ID Treatment   W0   W1   W4   W6
1.0  1         P 30.8 26.9 25.8 23.8
2.0  2         A 26.5 14.8 19.5 21.0
3.0  3         A 25.8 23.0 19.1 23.2
4.0  4         P 24.7 24.5 22.0 22.5
5.0  5         A 20.4  2.8  3.2  9.4
6.0  6         A 20.4  5.4  4.5 11.9</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb230"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb230-1"><a href="#cb230-1" aria-hidden="true" tabindex="-1"></a><span class="co">#balanced</span></span>
<span id="cb230-2"><a href="#cb230-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(TLC_long<span class="sc">$</span>ID)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
  1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19  20 
  4   4   4   4   4   4   4   4   4   4   4   4   4   4   4   4   4   4   4   4 
 21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39  40 
  4   4   4   4   4   4   4   4   4   4   4   4   4   4   4   4   4   4   4   4 
 41  42  43  44  45  46  47  48  49  50  51  52  53  54  55  56  57  58  59  60 
  4   4   4   4   4   4   4   4   4   4   4   4   4   4   4   4   4   4   4   4 
 61  62  63  64  65  66  67  68  69  70  71  72  73  74  75  76  77  78  79  80 
  4   4   4   4   4   4   4   4   4   4   4   4   4   4   4   4   4   4   4   4 
 81  82  83  84  85  86  87  88  89  90  91  92  93  94  95  96  97  98  99 100 
  4   4   4   4   4   4   4   4   4   4   4   4   4   4   4   4   4   4   4   4 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb232"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb232-1"><a href="#cb232-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Check for missing values</span></span>
<span id="cb232-2"><a href="#cb232-2" aria-hidden="true" tabindex="-1"></a><span class="fu">colSums</span>(<span class="fu">is.na</span>(TLC_long))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       ID Treatment      week         W 
        0         0         0         0 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb234"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb234-1"><a href="#cb234-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a Basic Boxplot to get a Sense of the Data</span></span>
<span id="cb234-2"><a href="#cb234-2" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(W <span class="sc">~</span> week <span class="sc">+</span> Treatment, <span class="at">data =</span> TLC_long)</span>
<span id="cb234-3"><a href="#cb234-3" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v=</span><span class="fl">4.5</span>) <span class="co"># Abline v=... draws a vertical line at 4.5 </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/box_long-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb235"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb235-1"><a href="#cb235-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Start with an xyplot </span></span>
<span id="cb235-2"><a href="#cb235-2" aria-hidden="true" tabindex="-1"></a><span class="co"># This requires the package 'lattice'</span></span>
<span id="cb235-3"><a href="#cb235-3" aria-hidden="true" tabindex="-1"></a><span class="co"># You can install using: install.packages("lattice")</span></span>
<span id="cb235-4"><a href="#cb235-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb235-5"><a href="#cb235-5" aria-hidden="true" tabindex="-1"></a>lattice<span class="sc">::</span><span class="fu">xyplot</span>(W <span class="sc">~</span> week <span class="sc">|</span> Treatment, </span>
<span id="cb235-6"><a href="#cb235-6" aria-hidden="true" tabindex="-1"></a>                <span class="at">data =</span> TLC_long, </span>
<span id="cb235-7"><a href="#cb235-7" aria-hidden="true" tabindex="-1"></a>                <span class="at">groups =</span> ID, </span>
<span id="cb235-8"><a href="#cb235-8" aria-hidden="true" tabindex="-1"></a>                <span class="at">col =</span> <span class="st">'black'</span>, </span>
<span id="cb235-9"><a href="#cb235-9" aria-hidden="true" tabindex="-1"></a>                <span class="at">type =</span> <span class="fu">c</span>(<span class="st">'l'</span>, <span class="st">'p'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/latt2-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb236"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb236-1"><a href="#cb236-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The plot is a mess, as-is, so instead we can subset!</span></span>
<span id="cb236-2"><a href="#cb236-2" aria-hidden="true" tabindex="-1"></a>plot_num <span class="ot">&lt;-</span> <span class="dv">5</span> <span class="co"># Select a fixed number</span></span>
<span id="cb236-3"><a href="#cb236-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-4"><a href="#cb236-4" aria-hidden="true" tabindex="-1"></a><span class="co"># This is Just Randomly Sampling from Each Group</span></span>
<span id="cb236-5"><a href="#cb236-5" aria-hidden="true" tabindex="-1"></a>random_samples_P <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">unique</span>(TLC_long<span class="sc">$</span>ID[<span class="fu">which</span>(TLC_long<span class="sc">$</span>Treatment <span class="sc">==</span> <span class="st">'P'</span>)]), </span>
<span id="cb236-6"><a href="#cb236-6" aria-hidden="true" tabindex="-1"></a>                         <span class="at">size =</span> plot_num,</span>
<span id="cb236-7"><a href="#cb236-7" aria-hidden="true" tabindex="-1"></a>                         <span class="at">replace =</span> <span class="cn">FALSE</span>)</span>
<span id="cb236-8"><a href="#cb236-8" aria-hidden="true" tabindex="-1"></a>random_samples_A <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">unique</span>(TLC_long<span class="sc">$</span>ID[<span class="fu">which</span>(TLC_long<span class="sc">$</span>Treatment <span class="sc">==</span> <span class="st">'A'</span>)]), </span>
<span id="cb236-9"><a href="#cb236-9" aria-hidden="true" tabindex="-1"></a>                           <span class="at">size =</span> plot_num,</span>
<span id="cb236-10"><a href="#cb236-10" aria-hidden="true" tabindex="-1"></a>                           <span class="at">replace =</span> <span class="cn">FALSE</span>)</span>
<span id="cb236-11"><a href="#cb236-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-12"><a href="#cb236-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-13"><a href="#cb236-13" aria-hidden="true" tabindex="-1"></a><span class="do">## Actually Draw the Plots</span></span>
<span id="cb236-14"><a href="#cb236-14" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb236-15"><a href="#cb236-15" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(W <span class="sc">~</span> week, <span class="at">data =</span> TLC_long, <span class="at">subset =</span> (Treatment <span class="sc">==</span> <span class="st">'P'</span>))</span>
<span id="cb236-16"><a href="#cb236-16" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (rid <span class="cf">in</span> random_samples_P){</span>
<span id="cb236-17"><a href="#cb236-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Loop through the Random Points and Draw the Corresponding Lines</span></span>
<span id="cb236-18"><a href="#cb236-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(W <span class="sc">~</span> week, </span>
<span id="cb236-19"><a href="#cb236-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> TLC_long, </span>
<span id="cb236-20"><a href="#cb236-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">subset =</span> (ID<span class="sc">==</span>rid), </span>
<span id="cb236-21"><a href="#cb236-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">type =</span> <span class="st">'l'</span>)</span>
<span id="cb236-22"><a href="#cb236-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb236-23"><a href="#cb236-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-24"><a href="#cb236-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Repeat it for Active Treatment</span></span>
<span id="cb236-25"><a href="#cb236-25" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(W <span class="sc">~</span> week, <span class="at">data =</span> TLC_long, <span class="at">subset =</span> (Treatment <span class="sc">==</span> <span class="st">'A'</span>))</span>
<span id="cb236-26"><a href="#cb236-26" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (rid <span class="cf">in</span> random_samples_A){</span>
<span id="cb236-27"><a href="#cb236-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(W <span class="sc">~</span> week, </span>
<span id="cb236-28"><a href="#cb236-28" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> TLC_long, </span>
<span id="cb236-29"><a href="#cb236-29" aria-hidden="true" tabindex="-1"></a>        <span class="at">subset =</span> (ID<span class="sc">==</span>rid), </span>
<span id="cb236-30"><a href="#cb236-30" aria-hidden="true" tabindex="-1"></a>        <span class="at">type =</span> <span class="st">'l'</span>)</span>
<span id="cb236-31"><a href="#cb236-31" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/random subset-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Correlation plot</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb237"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb237-1"><a href="#cb237-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This is a basic correlation plot</span></span>
<span id="cb237-2"><a href="#cb237-2" aria-hidden="true" tabindex="-1"></a><span class="co"># It requires the 'corrplot' library, which can be installed with</span></span>
<span id="cb237-3"><a href="#cb237-3" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("corrplot")</span></span>
<span id="cb237-4"><a href="#cb237-4" aria-hidden="true" tabindex="-1"></a>corrplot<span class="sc">::</span><span class="fu">corrplot.mixed</span>(<span class="fu">cor</span>(TLC_wide[<span class="fu">c</span>(<span class="st">"W0"</span>,<span class="st">"W1"</span>,<span class="st">"W4"</span>,<span class="st">"W6"</span>)]), </span>
<span id="cb237-5"><a href="#cb237-5" aria-hidden="true" tabindex="-1"></a>                         <span class="at">lower =</span> <span class="st">'number'</span>,</span>
<span id="cb237-6"><a href="#cb237-6" aria-hidden="true" tabindex="-1"></a>                         <span class="at">upper =</span> <span class="st">'square'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>What can we conclude from the EDA? What model could we propose in this case?</p>
</section>
<section id="longitudinal-data-as-a-mixed-effects-model" class="level3" data-number="1.6.2">
<h3 data-number="1.6.2" class="anchored" data-anchor-id="longitudinal-data-as-a-mixed-effects-model"><span class="header-section-number">1.6.2</span> Longitudinal Data as a mixed effects model</h3>
<ul>
<li>Looking at the XY plots, we see that the individual means seem to vary.</li>
<li>This means that each individual is likely to have a different mean</li>
<li>The treatment effect should be modelled as a fixed effect</li>
<li>How to model time effect?</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb238"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb238-1"><a href="#cb238-1" aria-hidden="true" tabindex="-1"></a>lattice<span class="sc">::</span><span class="fu">xyplot</span>(W <span class="sc">~</span> week <span class="sc">|</span> Treatment, </span>
<span id="cb238-2"><a href="#cb238-2" aria-hidden="true" tabindex="-1"></a>                <span class="at">data =</span> TLC_long, </span>
<span id="cb238-3"><a href="#cb238-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">groups =</span> ID, </span>
<span id="cb238-4"><a href="#cb238-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">col =</span> <span class="st">'black'</span>, </span>
<span id="cb238-5"><a href="#cb238-5" aria-hidden="true" tabindex="-1"></a>                <span class="at">type =</span> <span class="fu">c</span>(<span class="st">'l'</span>, <span class="st">'p'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/latt3-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>What are some ways we can model the time effect here?</p>
<p>Let’s fit a linear mixed effects model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb239"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb239-1"><a href="#cb239-1" aria-hidden="true" tabindex="-1"></a><span class="co"># head(TLC_long</span></span>
<span id="cb239-2"><a href="#cb239-2" aria-hidden="true" tabindex="-1"></a><span class="co"># head(TLC_long[order(TLC_long$ID),])</span></span>
<span id="cb239-3"><a href="#cb239-3" aria-hidden="true" tabindex="-1"></a><span class="fu">typeof</span>(TLC_long)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "list"</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb241"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb241-1"><a href="#cb241-1" aria-hidden="true" tabindex="-1"></a><span class="co">#REML</span></span>
<span id="cb241-2"><a href="#cb241-2" aria-hidden="true" tabindex="-1"></a><span class="co">#treat the time points as factors</span></span>
<span id="cb241-3"><a href="#cb241-3" aria-hidden="true" tabindex="-1"></a>TLC_long<span class="sc">$</span>week<span class="ot">=</span><span class="fu">as.factor</span>(TLC_long<span class="sc">$</span>week)</span>
<span id="cb241-4"><a href="#cb241-4" aria-hidden="true" tabindex="-1"></a><span class="co"># head(TLC_long)</span></span>
<span id="cb241-5"><a href="#cb241-5" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> nlme<span class="sc">::</span><span class="fu">lme</span>(<span class="at">fixed=</span> W <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span>Treatment<span class="sc">+</span>week<span class="sc">+</span>Treatment<span class="sc">*</span>week,</span>
<span id="cb241-6"><a href="#cb241-6" aria-hidden="true" tabindex="-1"></a>                   <span class="at">random=</span> <span class="sc">~</span><span class="dv">1</span><span class="sc">|</span>ID, <span class="at">data =</span> TLC_long) <span class="co">#to run the model</span></span>
<span id="cb241-7"><a href="#cb241-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb241-8"><a href="#cb241-8" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed-effects model fit by REML
  Data: TLC_long 
       AIC      BIC    logLik
  2480.621 2520.334 -1230.311

Random effects:
 Formula: ~1 | ID
        (Intercept) Residual
StdDev:    5.112717 4.214287

Fixed effects:  W ~ 1 + Treatment + week + Treatment * week 
                   Value Std.Error  DF    t-value p-value
(Intercept)       26.540 0.9370175 294  28.323912  0.0000
TreatmentP        -0.268 1.3251428  98  -0.202242  0.8401
week1            -13.018 0.8428574 294 -15.445080  0.0000
week4            -11.026 0.8428574 294 -13.081691  0.0000
week6             -5.778 0.8428574 294  -6.855252  0.0000
TreatmentP:week1  11.406 1.1919804 294   9.568950  0.0000
TreatmentP:week4   8.824 1.1919804 294   7.402807  0.0000
TreatmentP:week6   3.152 1.1919804 294   2.644339  0.0086
 Correlation: 
                 (Intr) TrtmnP week1  week4  week6  TrtP:1 TrtP:4
TreatmentP       -0.707                                          
week1            -0.450  0.318                                   
week4            -0.450  0.318  0.500                            
week6            -0.450  0.318  0.500  0.500                     
TreatmentP:week1  0.318 -0.450 -0.707 -0.354 -0.354              
TreatmentP:week4  0.318 -0.450 -0.354 -0.707 -0.354  0.500       
TreatmentP:week6  0.318 -0.450 -0.354 -0.354 -0.707  0.500  0.500

Standardized Within-Group Residuals:
        Min          Q1         Med          Q3         Max 
-4.18502705 -0.46501691 -0.04732964  0.36499878  7.66712566 

Number of Observations: 400
Number of Groups: 100 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb243"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb243-1"><a href="#cb243-1" aria-hidden="true" tabindex="-1"></a>nlme<span class="sc">::</span><span class="fu">intervals</span>(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Approximate 95% confidence intervals

 Fixed effects:
                       lower    est.      upper
(Intercept)       24.6958881  26.540  28.384112
TreatmentP        -2.8977028  -0.268   2.361703
week1            -14.6767987 -13.018 -11.359201
week4            -12.6847987 -11.026  -9.367201
week6             -7.4367987  -5.778  -4.119201
TreatmentP:week1   9.0601043  11.406  13.751896
TreatmentP:week4   6.4781043   8.824  11.169896
TreatmentP:week6   0.8061043   3.152   5.497896

 Random Effects:
  Level: ID 
                  lower     est.    upper
sd((Intercept)) 4.33785 5.112717 6.025997

 Within-group standard error:
   lower     est.    upper 
3.887059 4.214287 4.569062 </code></pre>
</div>
</div>
<p>What do we notice here?</p>
<ul>
<li>We see that the treatment effect is not significant in this model, but the interaction terms are.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb245"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb245-1"><a href="#cb245-1" aria-hidden="true" tabindex="-1"></a><span class="co">#we can plot the xy plot of the fitted values</span></span>
<span id="cb245-2"><a href="#cb245-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb245-3"><a href="#cb245-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb245-4"><a href="#cb245-4" aria-hidden="true" tabindex="-1"></a>yhat<span class="ot">=</span><span class="fu">predict</span>(model,<span class="at">newdata =</span> TLC_long[,<span class="sc">-</span><span class="dv">4</span>],<span class="at">level=</span><span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>)</span>
<span id="cb245-5"><a href="#cb245-5" aria-hidden="true" tabindex="-1"></a>TLC_long_2<span class="ot">=</span>TLC_long</span>
<span id="cb245-6"><a href="#cb245-6" aria-hidden="true" tabindex="-1"></a>TLC_long_2<span class="sc">$</span>yhat<span class="ot">=</span>yhat[,<span class="dv">3</span>]</span>
<span id="cb245-7"><a href="#cb245-7" aria-hidden="true" tabindex="-1"></a>TLC_long_2<span class="sc">$</span>week2<span class="ot">=</span><span class="fu">as.numeric</span>(<span class="fu">as.character</span>(TLC_long_2<span class="sc">$</span>week))</span>
<span id="cb245-8"><a href="#cb245-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb245-9"><a href="#cb245-9" aria-hidden="true" tabindex="-1"></a>lattice<span class="sc">::</span><span class="fu">xyplot</span>(yhat <span class="sc">~</span> week2<span class="sc">|</span>Treatment,<span class="at">data=</span>TLC_long_2  , <span class="at">groups =</span> ID, </span>
<span id="cb245-10"><a href="#cb245-10" aria-hidden="true" tabindex="-1"></a>                <span class="at">col =</span> <span class="st">'black'</span>, </span>
<span id="cb245-11"><a href="#cb245-11" aria-hidden="true" tabindex="-1"></a>                <span class="at">type =</span> <span class="fu">c</span>(<span class="st">'l'</span>, <span class="st">'p'</span>),<span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">60</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/GOF 4-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb246"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb246-1"><a href="#cb246-1" aria-hidden="true" tabindex="-1"></a><span class="co"># residuals over time?</span></span>
<span id="cb246-2"><a href="#cb246-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-3"><a href="#cb246-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Residuals vs. Fitted (no patterns)</span></span>
<span id="cb246-4"><a href="#cb246-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model, <span class="at">main =</span> <span class="st">"Plot of residuals vs. fitted."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/GOF 4-2.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb247"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb247-1"><a href="#cb247-1" aria-hidden="true" tabindex="-1"></a><span class="co"># QQPlot for normality of errors</span></span>
<span id="cb247-2"><a href="#cb247-2" aria-hidden="true" tabindex="-1"></a><span class="fu">qqnorm</span>(model, <span class="sc">~</span> <span class="fu">residuals</span>(., <span class="at">type=</span><span class="st">"pearson"</span>)) <span class="co"># Some issues... probably</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/GOF 4-3.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb248"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb248-1"><a href="#cb248-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plots for the Predicted (BLUPs)</span></span>
<span id="cb248-2"><a href="#cb248-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(nlme<span class="sc">::</span><span class="fu">ranef</span>(model)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/GOF 4-4.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb249"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb249-1"><a href="#cb249-1" aria-hidden="true" tabindex="-1"></a><span class="fu">qqnorm</span>(model, <span class="sc">~</span><span class="fu">ranef</span>(.)) <span class="co"># These look okay!</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/GOF 4-5.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb250"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb250-1"><a href="#cb250-1" aria-hidden="true" tabindex="-1"></a><span class="co"># model$residuals</span></span>
<span id="cb250-2"><a href="#cb250-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-3"><a href="#cb250-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-4"><a href="#cb250-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Observed vs. Fitted</span></span>
<span id="cb250-5"><a href="#cb250-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model, W <span class="sc">~</span> <span class="fu">fitted</span>(.), <span class="at">abline =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">main =</span> <span class="st">"Observed vs. Fitted"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/GOF 4-6.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb251"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb251-1"><a href="#cb251-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model, W<span class="sc">~</span> <span class="fu">fitted</span>(.)<span class="sc">|</span>ID, <span class="at">abline =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">main =</span> <span class="st">"Observed vs. Fitted (By Subject)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/GOF 4-7.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb252"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb252-1"><a href="#cb252-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Could also look (e.g.) by treatment, if it existed!</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Some thoughts</p>
<ul>
<li>Maybe we should investigate this residual… If this patient is outlying for indiosyncratic reasons we may want to remove them and redo the analysis</li>
<li>The fitted xy plots look like the empirical ones - good sign</li>
<li>Everything else looks pretty good</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb253"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb253-1"><a href="#cb253-1" aria-hidden="true" tabindex="-1"></a>id<span class="ot">=</span>TLC_long<span class="sc">$</span>ID[<span class="fu">which</span>(<span class="fu">residuals</span>(model, <span class="at">type=</span><span class="st">"pearson"</span>)<span class="sc">&gt;</span><span class="dv">5</span>)]</span>
<span id="cb253-2"><a href="#cb253-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb253-3"><a href="#cb253-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(TLC_long[TLC_long<span class="sc">$</span>ID<span class="sc">==</span>id,<span class="sc">-</span><span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb254"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb254-1"><a href="#cb254-1" aria-hidden="true" tabindex="-1"></a>col<span class="ot">=</span><span class="fu">rep</span>(<span class="dv">1</span>,<span class="dv">400</span>)</span>
<span id="cb254-2"><a href="#cb254-2" aria-hidden="true" tabindex="-1"></a>col[TLC_long<span class="sc">$</span>ID<span class="sc">==</span>id]<span class="ot">=</span><span class="dv">4</span></span>
<span id="cb254-3"><a href="#cb254-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-4"><a href="#cb254-4" aria-hidden="true" tabindex="-1"></a>lwd<span class="ot">=</span><span class="fu">rep</span>(<span class="dv">1</span>,<span class="dv">400</span>)</span>
<span id="cb254-5"><a href="#cb254-5" aria-hidden="true" tabindex="-1"></a>lwd[TLC_long<span class="sc">$</span>ID<span class="sc">==</span>id]<span class="ot">=</span><span class="dv">4</span></span>
<span id="cb254-6"><a href="#cb254-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-7"><a href="#cb254-7" aria-hidden="true" tabindex="-1"></a>lattice<span class="sc">::</span><span class="fu">xyplot</span>(W <span class="sc">~</span> week <span class="sc">|</span> Treatment, </span>
<span id="cb254-8"><a href="#cb254-8" aria-hidden="true" tabindex="-1"></a>                <span class="at">data =</span> TLC_long, </span>
<span id="cb254-9"><a href="#cb254-9" aria-hidden="true" tabindex="-1"></a>                <span class="at">groups =</span> ID, </span>
<span id="cb254-10"><a href="#cb254-10" aria-hidden="true" tabindex="-1"></a>                <span class="at">col =</span> col, </span>
<span id="cb254-11"><a href="#cb254-11" aria-hidden="true" tabindex="-1"></a>                <span class="at">type =</span> <span class="fu">c</span>(<span class="st">'l'</span>, <span class="st">'p'</span>),<span class="at">lwd=</span>lwd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/unnamed-chunk-8-2.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb255"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb255-1"><a href="#cb255-1" aria-hidden="true" tabindex="-1"></a><span class="fu">qqnorm</span>(model, <span class="sc">~</span><span class="fu">ranef</span>(.)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/unnamed-chunk-8-3.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb256"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb256-1"><a href="#cb256-1" aria-hidden="true" tabindex="-1"></a>TLC_long_3<span class="ot">=</span>TLC_long[TLC_long<span class="sc">$</span>ID<span class="sc">!=</span>id,]</span>
<span id="cb256-2"><a href="#cb256-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-3"><a href="#cb256-3" aria-hidden="true" tabindex="-1"></a>model2 <span class="ot">&lt;-</span> nlme<span class="sc">::</span><span class="fu">lme</span>(<span class="at">fixed=</span> W <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span>Treatment<span class="sc">+</span>week<span class="sc">+</span>Treatment<span class="sc">*</span>week,<span class="at">random=</span> <span class="sc">~</span><span class="dv">1</span><span class="sc">|</span>ID, <span class="at">data =</span> TLC_long_3) <span class="co">#to run the model</span></span>
<span id="cb256-4"><a href="#cb256-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-5"><a href="#cb256-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed-effects model fit by REML
  Data: TLC_long 
       AIC      BIC    logLik
  2480.621 2520.334 -1230.311

Random effects:
 Formula: ~1 | ID
        (Intercept) Residual
StdDev:    5.112717 4.214287

Fixed effects:  W ~ 1 + Treatment + week + Treatment * week 
                   Value Std.Error  DF    t-value p-value
(Intercept)       26.540 0.9370175 294  28.323912  0.0000
TreatmentP        -0.268 1.3251428  98  -0.202242  0.8401
week1            -13.018 0.8428574 294 -15.445080  0.0000
week4            -11.026 0.8428574 294 -13.081691  0.0000
week6             -5.778 0.8428574 294  -6.855252  0.0000
TreatmentP:week1  11.406 1.1919804 294   9.568950  0.0000
TreatmentP:week4   8.824 1.1919804 294   7.402807  0.0000
TreatmentP:week6   3.152 1.1919804 294   2.644339  0.0086
 Correlation: 
                 (Intr) TrtmnP week1  week4  week6  TrtP:1 TrtP:4
TreatmentP       -0.707                                          
week1            -0.450  0.318                                   
week4            -0.450  0.318  0.500                            
week6            -0.450  0.318  0.500  0.500                     
TreatmentP:week1  0.318 -0.450 -0.707 -0.354 -0.354              
TreatmentP:week4  0.318 -0.450 -0.354 -0.707 -0.354  0.500       
TreatmentP:week6  0.318 -0.450 -0.354 -0.354 -0.707  0.500  0.500

Standardized Within-Group Residuals:
        Min          Q1         Med          Q3         Max 
-4.18502705 -0.46501691 -0.04732964  0.36499878  7.66712566 

Number of Observations: 400
Number of Groups: 100 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb258"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb258-1"><a href="#cb258-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed-effects model fit by REML
  Data: TLC_long_3 
      AIC     BIC    logLik
  2371.01 2410.62 -1175.505

Random effects:
 Formula: ~1 | ID
        (Intercept) Residual
StdDev:    5.083126 3.671238

Fixed effects:  W ~ 1 + Treatment + week + Treatment * week 
                      Value Std.Error  DF    t-value p-value
(Intercept)       26.393878 0.8957514 291  29.465627  0.0000
TreatmentP        -0.121878 1.2604340  97  -0.096695  0.9232
week1            -12.900000 0.7417021 291 -17.392428  0.0000
week4            -10.859184 0.7417021 291 -14.640897  0.0000
week6             -6.512245 0.7417021 291  -8.780135  0.0000
TreatmentP:week1  11.288000 1.0436674 291  10.815707  0.0000
TreatmentP:week4   8.657184 1.0436674 291   8.294964  0.0000
TreatmentP:week6   3.886245 1.0436674 291   3.723643  0.0002
 Correlation: 
                 (Intr) TrtmnP week1  week4  week6  TrtP:1 TrtP:4
TreatmentP       -0.711                                          
week1            -0.414  0.294                                   
week4            -0.414  0.294  0.500                            
week6            -0.414  0.294  0.500  0.500                     
TreatmentP:week1  0.294 -0.414 -0.711 -0.355 -0.355              
TreatmentP:week4  0.294 -0.414 -0.355 -0.711 -0.355  0.500       
TreatmentP:week6  0.294 -0.414 -0.355 -0.355 -0.711  0.500  0.500

Standardized Within-Group Residuals:
        Min          Q1         Med          Q3         Max 
-4.63582605 -0.49846350 -0.05679961  0.40026479  3.28119867 

Number of Observations: 396
Number of Groups: 99 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb260"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb260-1"><a href="#cb260-1" aria-hidden="true" tabindex="-1"></a>nlme<span class="sc">::</span><span class="fu">intervals</span>(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Approximate 95% confidence intervals

 Fixed effects:
                       lower    est.      upper
(Intercept)       24.6958881  26.540  28.384112
TreatmentP        -2.8977028  -0.268   2.361703
week1            -14.6767987 -13.018 -11.359201
week4            -12.6847987 -11.026  -9.367201
week6             -7.4367987  -5.778  -4.119201
TreatmentP:week1   9.0601043  11.406  13.751896
TreatmentP:week4   6.4781043   8.824  11.169896
TreatmentP:week6   0.8061043   3.152   5.497896

 Random Effects:
  Level: ID 
                  lower     est.    upper
sd((Intercept)) 4.33785 5.112717 6.025997

 Within-group standard error:
   lower     est.    upper 
3.887059 4.214287 4.569062 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb262"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb262-1"><a href="#cb262-1" aria-hidden="true" tabindex="-1"></a>nlme<span class="sc">::</span><span class="fu">intervals</span>(model2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Approximate 95% confidence intervals

 Fixed effects:
                      lower        est.      upper
(Intercept)       24.630905  26.3938776  28.156850
TreatmentP        -2.623490  -0.1218776   2.379735
week1            -14.359781 -12.9000000 -11.440219
week4            -12.318964 -10.8591837  -9.399403
week6             -7.972026  -6.5122449  -5.052464
TreatmentP:week1   9.233907  11.2880000  13.342093
TreatmentP:week4   6.603090   8.6571837  10.711277
TreatmentP:week6   1.832151   3.8862449   5.940338

 Random Effects:
  Level: ID 
                   lower     est.    upper
sd((Intercept)) 4.334069 5.083126 5.961643

 Within-group standard error:
   lower     est.    upper 
3.384769 3.671238 3.981952 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb264"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb264-1"><a href="#cb264-1" aria-hidden="true" tabindex="-1"></a>nlme<span class="sc">::</span><span class="fu">fixef</span>(model)<span class="sc">-</span>nlme<span class="sc">::</span><span class="fu">fixef</span>(model2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     (Intercept)       TreatmentP            week1            week4 
       0.1461224       -0.1461224       -0.1180000       -0.1668163 
           week6 TreatmentP:week1 TreatmentP:week4 TreatmentP:week6 
       0.7342449        0.1180000        0.1668163       -0.7342449 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb266"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb266-1"><a href="#cb266-1" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(model2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               numDF denDF   F-value p-value
(Intercept)        1   291 1606.9197  &lt;.0001
Treatment          1    97   28.8577  &lt;.0001
week               3   291   77.0542  &lt;.0001
Treatment:week     3   291   46.2000  &lt;.0001</code></pre>
</div>
</div>
</section>
<section id="sensitivity-analysis---we-could-have-fit-a-quadratic-or-piece-wise-linear-model-to-the-data." class="level3" data-number="1.6.3">
<h3 data-number="1.6.3" class="anchored" data-anchor-id="sensitivity-analysis---we-could-have-fit-a-quadratic-or-piece-wise-linear-model-to-the-data."><span class="header-section-number">1.6.3</span> Sensitivity analysis - We could have fit a quadratic or piece-wise linear model to the data.</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb268"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb268-1"><a href="#cb268-1" aria-hidden="true" tabindex="-1"></a>TLC_long_pl<span class="ot">=</span>TLC_long_3</span>
<span id="cb268-2"><a href="#cb268-2" aria-hidden="true" tabindex="-1"></a>TLC_long_pl<span class="sc">$</span>week<span class="ot">=</span><span class="fu">as.numeric</span>(<span class="fu">as.character</span>(TLC_long_3<span class="sc">$</span>week))<span class="sc">+</span><span class="dv">1</span></span>
<span id="cb268-3"><a href="#cb268-3" aria-hidden="true" tabindex="-1"></a>TLC_long_pl<span class="sc">$</span>time1<span class="ot">=</span>(TLC_long_pl<span class="sc">$</span>week<span class="sc">&lt;</span><span class="dv">2</span>)<span class="sc">*</span>TLC_long_pl<span class="sc">$</span>week</span>
<span id="cb268-4"><a href="#cb268-4" aria-hidden="true" tabindex="-1"></a><span class="co"># TLC_long_pl$time2=(TLC_long_pl$week&gt;=3)*(TLC_long_pl$week-TLC_long_pl$week)</span></span>
<span id="cb268-5"><a href="#cb268-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(TLC_long_pl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    ID Treatment week    W time1
1.0  1         P    1 30.8     1
2.0  2         A    1 26.5     1
3.0  3         A    1 25.8     1
4.0  4         P    1 24.7     1
5.0  5         A    1 20.4     1
6.0  6         A    1 20.4     1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb270"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb270-1"><a href="#cb270-1" aria-hidden="true" tabindex="-1"></a>lattice<span class="sc">::</span><span class="fu">xyplot</span>(W <span class="sc">~</span> week<span class="sc">|</span>Treatment,<span class="at">data=</span>TLC_long_pl  , <span class="at">groups =</span> ID, </span>
<span id="cb270-2"><a href="#cb270-2" aria-hidden="true" tabindex="-1"></a>                <span class="at">col =</span> <span class="st">'black'</span>, </span>
<span id="cb270-3"><a href="#cb270-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">type =</span> <span class="fu">c</span>(<span class="st">'l'</span>, <span class="st">'p'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb271"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb271-1"><a href="#cb271-1" aria-hidden="true" tabindex="-1"></a>model_pl <span class="ot">&lt;-</span> nlme<span class="sc">::</span><span class="fu">lme</span>(<span class="at">fixed=</span> W <span class="sc">~</span> week<span class="sc">+</span>time1<span class="sc">+</span>Treatment<span class="sc">+</span>Treatment<span class="sc">*</span>week<span class="sc">+</span>Treatment<span class="sc">*</span>time1,<span class="at">random=</span> <span class="sc">~</span><span class="dv">1</span><span class="sc">|</span>ID, <span class="at">data =</span> TLC_long_pl) <span class="co">#to run the model</span></span>
<span id="cb271-2"><a href="#cb271-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_pl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed-effects model fit by REML
  Data: TLC_long_pl 
       AIC      BIC    logLik
  2382.985 2414.714 -1183.492

Random effects:
 Formula: ~1 | ID
        (Intercept) Residual
StdDev:    5.076697 3.706653

Fixed effects:  W ~ week + time1 + Treatment + Treatment * week + Treatment *      time1 
                      Value Std.Error  DF    t-value p-value
(Intercept)       10.561547 1.0495337 293  10.063085       0
week               1.230397 0.1487828 293   8.269756       0
time1             14.601933 0.8194318 293  17.819584       0
TreatmentP        14.507927 1.4768248  97   9.823729       0
week:TreatmentP   -1.432713 0.2093560 293  -6.843432       0
time1:TreatmentP -13.197091 1.1530427 293 -11.445449       0
 Correlation: 
                 (Intr) week   time1  TrtmnP wk:TrP
week             -0.662                            
time1            -0.549  0.666                     
TreatmentP       -0.711  0.470  0.390              
week:TreatmentP   0.470 -0.711 -0.473 -0.662       
time1:TreatmentP  0.390 -0.473 -0.711 -0.549  0.666

Standardized Within-Group Residuals:
        Min          Q1         Med          Q3         Max 
-4.39986915 -0.47078045 -0.04895001  0.39625544  3.32467517 

Number of Observations: 396
Number of Groups: 99 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb273"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb273-1"><a href="#cb273-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed-effects model fit by REML
  Data: TLC_long_3 
      AIC     BIC    logLik
  2371.01 2410.62 -1175.505

Random effects:
 Formula: ~1 | ID
        (Intercept) Residual
StdDev:    5.083126 3.671238

Fixed effects:  W ~ 1 + Treatment + week + Treatment * week 
                      Value Std.Error  DF    t-value p-value
(Intercept)       26.393878 0.8957514 291  29.465627  0.0000
TreatmentP        -0.121878 1.2604340  97  -0.096695  0.9232
week1            -12.900000 0.7417021 291 -17.392428  0.0000
week4            -10.859184 0.7417021 291 -14.640897  0.0000
week6             -6.512245 0.7417021 291  -8.780135  0.0000
TreatmentP:week1  11.288000 1.0436674 291  10.815707  0.0000
TreatmentP:week4   8.657184 1.0436674 291   8.294964  0.0000
TreatmentP:week6   3.886245 1.0436674 291   3.723643  0.0002
 Correlation: 
                 (Intr) TrtmnP week1  week4  week6  TrtP:1 TrtP:4
TreatmentP       -0.711                                          
week1            -0.414  0.294                                   
week4            -0.414  0.294  0.500                            
week6            -0.414  0.294  0.500  0.500                     
TreatmentP:week1  0.294 -0.414 -0.711 -0.355 -0.355              
TreatmentP:week4  0.294 -0.414 -0.355 -0.711 -0.355  0.500       
TreatmentP:week6  0.294 -0.414 -0.355 -0.355 -0.711  0.500  0.500

Standardized Within-Group Residuals:
        Min          Q1         Med          Q3         Max 
-4.63582605 -0.49846350 -0.05679961  0.40026479  3.28119867 

Number of Observations: 396
Number of Groups: 99 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb275"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb275-1"><a href="#cb275-1" aria-hidden="true" tabindex="-1"></a><span class="co">#we can plot the xy plot of the fitted values</span></span>
<span id="cb275-2"><a href="#cb275-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb275-3"><a href="#cb275-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb275-4"><a href="#cb275-4" aria-hidden="true" tabindex="-1"></a>yhat<span class="ot">=</span><span class="fu">predict</span>(model_pl,<span class="at">newdata =</span> TLC_long_pl[,<span class="sc">-</span><span class="dv">4</span>],<span class="at">level=</span><span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>)</span>
<span id="cb275-5"><a href="#cb275-5" aria-hidden="true" tabindex="-1"></a>TLC_long_4<span class="ot">=</span>TLC_long_pl</span>
<span id="cb275-6"><a href="#cb275-6" aria-hidden="true" tabindex="-1"></a>TLC_long_4<span class="sc">$</span>yhat<span class="ot">=</span>yhat[,<span class="dv">3</span>]</span>
<span id="cb275-7"><a href="#cb275-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb275-8"><a href="#cb275-8" aria-hidden="true" tabindex="-1"></a>lattice<span class="sc">::</span><span class="fu">xyplot</span>(yhat <span class="sc">~</span> week<span class="sc">|</span>Treatment,<span class="at">data=</span>TLC_long_4  , <span class="at">groups =</span> ID, </span>
<span id="cb275-9"><a href="#cb275-9" aria-hidden="true" tabindex="-1"></a>                <span class="at">col =</span> <span class="st">'black'</span>, </span>
<span id="cb275-10"><a href="#cb275-10" aria-hidden="true" tabindex="-1"></a>                <span class="at">type =</span> <span class="fu">c</span>(<span class="st">'l'</span>, <span class="st">'p'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/GOF 5-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb276"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb276-1"><a href="#cb276-1" aria-hidden="true" tabindex="-1"></a>lattice<span class="sc">::</span><span class="fu">xyplot</span>(yhat <span class="sc">~</span> week<span class="sc">|</span>Treatment,<span class="at">data=</span>TLC_long_2  , <span class="at">groups =</span> ID, </span>
<span id="cb276-2"><a href="#cb276-2" aria-hidden="true" tabindex="-1"></a>                <span class="at">col =</span> <span class="st">'black'</span>, </span>
<span id="cb276-3"><a href="#cb276-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">type =</span> <span class="fu">c</span>(<span class="st">'l'</span>, <span class="st">'p'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/GOF 5-2.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb277"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb277-1"><a href="#cb277-1" aria-hidden="true" tabindex="-1"></a>lattice<span class="sc">::</span><span class="fu">xyplot</span>(W <span class="sc">~</span> week<span class="sc">|</span>Treatment,<span class="at">data=</span>TLC_long_2  , <span class="at">groups =</span> ID, </span>
<span id="cb277-2"><a href="#cb277-2" aria-hidden="true" tabindex="-1"></a>                <span class="at">col =</span> <span class="st">'black'</span>, </span>
<span id="cb277-3"><a href="#cb277-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">type =</span> <span class="fu">c</span>(<span class="st">'l'</span>, <span class="st">'p'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/GOF 5-3.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb278"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb278-1"><a href="#cb278-1" aria-hidden="true" tabindex="-1"></a><span class="co"># residuals over time?</span></span>
<span id="cb278-2"><a href="#cb278-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb278-3"><a href="#cb278-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Residuals vs. Fitted (no patterns)</span></span>
<span id="cb278-4"><a href="#cb278-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model_pl, <span class="at">main =</span> <span class="st">"Plot of residuals vs. fitted."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/GOF 6-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb279"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb279-1"><a href="#cb279-1" aria-hidden="true" tabindex="-1"></a><span class="co"># QQPlot for normality of errors</span></span>
<span id="cb279-2"><a href="#cb279-2" aria-hidden="true" tabindex="-1"></a><span class="fu">qqnorm</span>(model_pl, <span class="sc">~</span> <span class="fu">residuals</span>(., <span class="at">type=</span><span class="st">"pearson"</span>)) <span class="co"># Some issues... probably</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/GOF 6-2.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb280"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb280-1"><a href="#cb280-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plots for the Predicted (BLUPs)</span></span>
<span id="cb280-2"><a href="#cb280-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(nlme<span class="sc">::</span><span class="fu">ranef</span>(model_pl)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/GOF 6-3.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb281"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb281-1"><a href="#cb281-1" aria-hidden="true" tabindex="-1"></a><span class="fu">qqnorm</span>(model_pl, <span class="sc">~</span><span class="fu">ranef</span>(.)) <span class="co"># These look okay!</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/GOF 6-4.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb282"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb282-1"><a href="#cb282-1" aria-hidden="true" tabindex="-1"></a><span class="co"># model$residuals</span></span>
<span id="cb282-2"><a href="#cb282-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb282-3"><a href="#cb282-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb282-4"><a href="#cb282-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Observed vs. Fitted</span></span>
<span id="cb282-5"><a href="#cb282-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model_pl, W <span class="sc">~</span> <span class="fu">fitted</span>(.), <span class="at">abline =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">main =</span> <span class="st">"Observed vs. Fitted"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/GOF 6-5.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb283"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb283-1"><a href="#cb283-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Could also look (e.g.) by treatment, if it existed!</span></span>
<span id="cb283-2"><a href="#cb283-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb283-3"><a href="#cb283-3" aria-hidden="true" tabindex="-1"></a>residuals<span class="ot">=</span><span class="fu">residuals</span>(model_pl, <span class="at">type=</span><span class="st">"pearson"</span>)</span>
<span id="cb283-4"><a href="#cb283-4" aria-hidden="true" tabindex="-1"></a>re<span class="ot">=</span>nlme<span class="sc">::</span><span class="fu">ranef</span>(model_pl)</span>
<span id="cb283-5"><a href="#cb283-5" aria-hidden="true" tabindex="-1"></a>re2<span class="ot">=</span><span class="fu">rep</span>(re<span class="sc">$</span><span class="st">`</span><span class="at">(Intercept)</span><span class="st">`</span> ,<span class="at">each=</span><span class="dv">4</span>)</span>
<span id="cb283-6"><a href="#cb283-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb283-7"><a href="#cb283-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(residuals,re2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/GOF 6-6.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb284"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb284-1"><a href="#cb284-1" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(residuals)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 396</code></pre>
</div>
<div class="sourceCode cell-code" id="cb286"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb286-1"><a href="#cb286-1" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(re)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb288"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb288-1"><a href="#cb288-1" aria-hidden="true" tabindex="-1"></a>TLC_long_pl<span class="sc">$</span>weeksq<span class="ot">=</span> TLC_long_pl<span class="sc">$</span>week<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb288-2"><a href="#cb288-2" aria-hidden="true" tabindex="-1"></a>model_q <span class="ot">&lt;-</span> nlme<span class="sc">::</span><span class="fu">lme</span>(<span class="at">fixed=</span> W <span class="sc">~</span> week<span class="sc">+</span>weeksq<span class="sc">+</span>Treatment<span class="sc">+</span>week<span class="sc">*</span>Treatment<span class="sc">+</span>weeksq<span class="sc">*</span>Treatment,<span class="at">random=</span> <span class="sc">~</span><span class="dv">1</span><span class="sc">|</span>ID, <span class="at">data =</span> TLC_long_pl) <span class="co">#to run the model</span></span>
<span id="cb288-3"><a href="#cb288-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_q)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed-effects model fit by REML
  Data: TLC_long_pl 
      AIC      BIC   logLik
  2485.78 2517.509 -1234.89

Random effects:
 Formula: ~1 | ID
        (Intercept) Residual
StdDev:    4.948122 4.346842

Fixed effects:  W ~ week + weeksq + Treatment + week * Treatment + weeksq * Treatment 
                     Value Std.Error  DF    t-value p-value
(Intercept)       32.08886 1.2914204 293  24.847722   0.000
week              -9.43993 0.7337490 293 -12.865333   0.000
weeksq             1.12085 0.0908875 293  12.332330   0.000
TreatmentP        -5.11030 1.8171896  97  -2.812198   0.006
week:TreatmentP    8.33921 1.0324764 293   8.076897   0.000
weeksq:TreatmentP -1.02915 0.1278901 293  -8.047157   0.000
 Correlation: 
                  (Intr) week   weeksq TrtmnP wk:TrP
week              -0.763                            
weeksq             0.707 -0.984                     
TreatmentP        -0.711  0.542 -0.502              
week:TreatmentP    0.542 -0.711  0.699 -0.763       
weeksq:TreatmentP -0.502  0.699 -0.711  0.707 -0.984

Standardized Within-Group Residuals:
        Min          Q1         Med          Q3         Max 
-4.14185550 -0.45450738 -0.04543433  0.47296981  3.35222137 

Number of Observations: 396
Number of Groups: 99 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb290"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb290-1"><a href="#cb290-1" aria-hidden="true" tabindex="-1"></a><span class="co"># model_q &lt;- nlme::lme(fixed= W ~ week+weeksq+Treatment+weeksq*Treatment,random= ~1|ID, data = TLC_long_pl) #to run the model</span></span>
<span id="cb290-2"><a href="#cb290-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_q)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed-effects model fit by REML
  Data: TLC_long_pl 
      AIC      BIC   logLik
  2485.78 2517.509 -1234.89

Random effects:
 Formula: ~1 | ID
        (Intercept) Residual
StdDev:    4.948122 4.346842

Fixed effects:  W ~ week + weeksq + Treatment + week * Treatment + weeksq * Treatment 
                     Value Std.Error  DF    t-value p-value
(Intercept)       32.08886 1.2914204 293  24.847722   0.000
week              -9.43993 0.7337490 293 -12.865333   0.000
weeksq             1.12085 0.0908875 293  12.332330   0.000
TreatmentP        -5.11030 1.8171896  97  -2.812198   0.006
week:TreatmentP    8.33921 1.0324764 293   8.076897   0.000
weeksq:TreatmentP -1.02915 0.1278901 293  -8.047157   0.000
 Correlation: 
                  (Intr) week   weeksq TrtmnP wk:TrP
week              -0.763                            
weeksq             0.707 -0.984                     
TreatmentP        -0.711  0.542 -0.502              
week:TreatmentP    0.542 -0.711  0.699 -0.763       
weeksq:TreatmentP -0.502  0.699 -0.711  0.707 -0.984

Standardized Within-Group Residuals:
        Min          Q1         Med          Q3         Max 
-4.14185550 -0.45450738 -0.04543433  0.47296981  3.35222137 

Number of Observations: 396
Number of Groups: 99 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb292"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb292-1"><a href="#cb292-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed-effects model fit by REML
  Data: TLC_long_3 
      AIC     BIC    logLik
  2371.01 2410.62 -1175.505

Random effects:
 Formula: ~1 | ID
        (Intercept) Residual
StdDev:    5.083126 3.671238

Fixed effects:  W ~ 1 + Treatment + week + Treatment * week 
                      Value Std.Error  DF    t-value p-value
(Intercept)       26.393878 0.8957514 291  29.465627  0.0000
TreatmentP        -0.121878 1.2604340  97  -0.096695  0.9232
week1            -12.900000 0.7417021 291 -17.392428  0.0000
week4            -10.859184 0.7417021 291 -14.640897  0.0000
week6             -6.512245 0.7417021 291  -8.780135  0.0000
TreatmentP:week1  11.288000 1.0436674 291  10.815707  0.0000
TreatmentP:week4   8.657184 1.0436674 291   8.294964  0.0000
TreatmentP:week6   3.886245 1.0436674 291   3.723643  0.0002
 Correlation: 
                 (Intr) TrtmnP week1  week4  week6  TrtP:1 TrtP:4
TreatmentP       -0.711                                          
week1            -0.414  0.294                                   
week4            -0.414  0.294  0.500                            
week6            -0.414  0.294  0.500  0.500                     
TreatmentP:week1  0.294 -0.414 -0.711 -0.355 -0.355              
TreatmentP:week4  0.294 -0.414 -0.355 -0.711 -0.355  0.500       
TreatmentP:week6  0.294 -0.414 -0.355 -0.355 -0.711  0.500  0.500

Standardized Within-Group Residuals:
        Min          Q1         Med          Q3         Max 
-4.63582605 -0.49846350 -0.05679961  0.40026479  3.28119867 

Number of Observations: 396
Number of Groups: 99 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb294"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb294-1"><a href="#cb294-1" aria-hidden="true" tabindex="-1"></a><span class="co">#we can plot the xy plot of the fitted values</span></span>
<span id="cb294-2"><a href="#cb294-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb294-3"><a href="#cb294-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb294-4"><a href="#cb294-4" aria-hidden="true" tabindex="-1"></a>yhat<span class="ot">=</span><span class="fu">predict</span>(model_q,<span class="at">newdata =</span> TLC_long_pl[,<span class="sc">-</span><span class="dv">4</span>],<span class="at">level=</span><span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>)</span>
<span id="cb294-5"><a href="#cb294-5" aria-hidden="true" tabindex="-1"></a>TLC_long_5<span class="ot">=</span>TLC_long_pl</span>
<span id="cb294-6"><a href="#cb294-6" aria-hidden="true" tabindex="-1"></a>TLC_long_5<span class="sc">$</span>yhat<span class="ot">=</span>yhat[,<span class="dv">3</span>]</span>
<span id="cb294-7"><a href="#cb294-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb294-8"><a href="#cb294-8" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb294-9"><a href="#cb294-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb294-10"><a href="#cb294-10" aria-hidden="true" tabindex="-1"></a>lattice<span class="sc">::</span><span class="fu">xyplot</span>(yhat <span class="sc">~</span> week<span class="sc">|</span>Treatment,<span class="at">data=</span>TLC_long_5  , <span class="at">groups =</span> ID, </span>
<span id="cb294-11"><a href="#cb294-11" aria-hidden="true" tabindex="-1"></a>                <span class="at">col =</span> <span class="st">'black'</span>, </span>
<span id="cb294-12"><a href="#cb294-12" aria-hidden="true" tabindex="-1"></a>                <span class="at">type =</span> <span class="fu">c</span>(<span class="st">'l'</span>, <span class="st">'p'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/GOF 7-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb295"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb295-1"><a href="#cb295-1" aria-hidden="true" tabindex="-1"></a>lattice<span class="sc">::</span><span class="fu">xyplot</span>(yhat <span class="sc">~</span> week<span class="sc">|</span>Treatment,<span class="at">data=</span>TLC_long_4  , <span class="at">groups =</span> ID, </span>
<span id="cb295-2"><a href="#cb295-2" aria-hidden="true" tabindex="-1"></a>                <span class="at">col =</span> <span class="st">'black'</span>, </span>
<span id="cb295-3"><a href="#cb295-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">type =</span> <span class="fu">c</span>(<span class="st">'l'</span>, <span class="st">'p'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/GOF 7-2.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb296"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb296-1"><a href="#cb296-1" aria-hidden="true" tabindex="-1"></a>lattice<span class="sc">::</span><span class="fu">xyplot</span>(yhat <span class="sc">~</span> week<span class="sc">|</span>Treatment,<span class="at">data=</span>TLC_long_2  , <span class="at">groups =</span> ID, </span>
<span id="cb296-2"><a href="#cb296-2" aria-hidden="true" tabindex="-1"></a>                <span class="at">col =</span> <span class="st">'black'</span>, </span>
<span id="cb296-3"><a href="#cb296-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">type =</span> <span class="fu">c</span>(<span class="st">'l'</span>, <span class="st">'p'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/GOF 7-3.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb297"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb297-1"><a href="#cb297-1" aria-hidden="true" tabindex="-1"></a>lattice<span class="sc">::</span><span class="fu">xyplot</span>(W <span class="sc">~</span> week<span class="sc">|</span>Treatment,<span class="at">data=</span>TLC_long_2  , <span class="at">groups =</span> ID, </span>
<span id="cb297-2"><a href="#cb297-2" aria-hidden="true" tabindex="-1"></a>                <span class="at">col =</span> <span class="st">'black'</span>, </span>
<span id="cb297-3"><a href="#cb297-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">type =</span> <span class="fu">c</span>(<span class="st">'l'</span>, <span class="st">'p'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="mixed_models_files/figure-html/GOF 7-4.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Conclusions:</p>
<ul>
<li>All models indicate a significant effect of treatment, with the largest drop being a time point
<ol type="1">
<li></li>
</ol></li>
<li>The lead levels seem to be returning to baseline over time</li>
<li>The treatment certainly reduces lead levels for a few weeks</li>
<li>Investigate subject data with ID 40.</li>
</ul>
<p>We can get more specific too</p>
<ul>
<li>At time point 1, individual lead levels seem to drop by 11 points over the placebo.</li>
<li>After that, the gap starts closing over time - valued at 11, 8, and then 3</li>
</ul>


<div id="refs" class="references csl-bib-body hanging-indent" role="list" style="display: none">
<div id="ref-Cabrera2002" class="csl-entry" role="listitem">
Cabrera, Javier, and Andrew McDougall. 2002. <em>Statistical Consulting</em>. Springer New York. <a href="https://doi.org/10.1007/978-1-4757-3663-2">https://doi.org/10.1007/978-1-4757-3663-2</a>.
</div>
<div id="ref-Gelman2006" class="csl-entry" role="listitem">
Gelman, Andrew, and Jennifer Hill. 2006. <em>Data Analysis Using Regression and Multilevel/Hierarchical Models</em>. Cambridge University Press. <a href="https://doi.org/10.1017/cbo9780511790942">https://doi.org/10.1017/cbo9780511790942</a>.
</div>
<div id="ref-Pinheiro2000" class="csl-entry" role="listitem">
Pinheiro, J. C., and D. Bates. 2009. <em>Mixed-Effects Models in s and s-PLUS</em>. Statistics and Computing. Springer. <a href="https://books.google.ca/books?id=y54QDUTmvDcC">https://books.google.ca/books?id=y54QDUTmvDcC</a>.
</div>
<div id="ref-Wu2019" class="csl-entry" role="listitem">
Wu, Lang. 2019. <em>Mixed Effects Models for Complex Data</em>. Chapman &amp; Hall/CRC Monographs on Statistics &amp; Applied Probability. Philadelphia, PA: Chapman &amp; Hall/CRC.
</div>
</div>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./index.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Preface</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./references.html" class="pagination-link">
        <span class="nav-page-text">References</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>